<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practical Malware Analysis - Lab 12 &mdash; abdelrahmn walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Practical Malware Analysis - Lab 11" href="../lab11/lab11.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahmn walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Practical Malware Analysis - Lab 12</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-12-1">Lab 12-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-12-2">Lab 12-2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-12-3">Lab 12-3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-12-4">Lab 12-4</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahmn walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Practical Malware Analysis - Lab 12</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lab12/lab12.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="practical-malware-analysis-lab-12">
<h1>Practical Malware Analysis - Lab 12<a class="headerlink" href="#practical-malware-analysis-lab-12" title="Permalink to this heading"></a></h1>
<section id="lab-12-1">
<h2>Lab 12-1<a class="headerlink" href="#lab-12-1" title="Permalink to this heading"></a></h2>
<p>Analyze the malware found in the file Lab12-01.exe and Lab12-01.dll. Make
sure that these files are in the same directory when performing the analysis.</p>
<p><strong>Q1: What happens when you run the malware executable?</strong></p>
<p>On procmon we don’t get much but noticed a lot of file mapping into memory maybe it will modify some process in memory</p>
<img alt="../_images/1q23.png" src="../_images/1q23.png" />
<p><strong>Q2: What process is being injected?</strong></p>
<p>lets pull the exe into ida, in imports we see CreateRemoteThread and the required functions for it, we could say it uses dll
injection into remote thread</p>
<img alt="../_images/1q33.png" src="../_images/1q33.png" />
<p>Look at the functions list we find only one function then the main function
in sub_401000 we see all its doing is converting PID to a process name then comparing it to explorer.exe to return 1
so we can say its injecting explorer (Almost same <code class="docutils literal notranslate"><span class="pre">PrintProcessNameAndID</span></code> function in (MSDN)[<a class="reference external" href="https://learn.microsoft.com/en-us/windows/win32/psapi/enumerating-all-processes">https://learn.microsoft.com/en-us/windows/win32/psapi/enumerating-all-processes</a>] )</p>
<img alt="../_images/1q52.png" src="../_images/1q52.png" />
<p><strong>Q3: How can you make the malware stop the pop-ups?</strong></p>
<p>By restarting explorer.exe like cmd command <code class="docutils literal notranslate"><span class="pre">wmic</span> <span class="pre">process</span> <span class="pre">where</span> <span class="pre">name=&quot;explorer.exe&quot;</span> <span class="pre">call</span> <span class="pre">terminate</span></code></p>
<p><strong>Q4: How does this malware operate?</strong></p>
<p>lets go over the exe, in first part its importing psapi.dll functions:EnumProcessModules, EnumProcesses,GetModuleBaseNameA (they do as their name suggests)
then it sets <code class="docutils literal notranslate"><span class="pre">Buffer</span></code> to Lab12-01.dll location</p>
<img alt="../_images/1q62.png" src="../_images/1q62.png" />
<p>Second part enumerating-all-processes then saving list of process identifiers in dwprocessid, and saving number of processes in v7 (v14 &gt;&gt;&gt;2-&gt;v14 / 2^2  where 4 bytes is size of DWORD ,its calculating all bytes returns over size of single process)
then it is passing all process identifiers (pid) to 40100 function we said above to check if there is explorer, when found it gets a handle to explorer</p>
<img alt="../_images/1q72.png" src="../_images/1q72.png" />
<p>Now the overhead is done, the main part here, first it allocates space in explorer process memory then writing Lab12-01.dll to it
then calling CreateRemoteThread with all prepared parameters (handle to loadlibrary +handle to explorer +the base address where Lab12-01.dll where written to ,to load it )</p>
<img alt="../_images/1q82.png" src="../_images/1q82.png" />
<p>in the dll simple program in a loop to create a thread with open messagebox</p>
<img alt="../_images/1q91.png" src="../_images/1q91.png" />
<img alt="../_images/1q101.png" src="../_images/1q101.png" />
</section>
<section id="lab-12-2">
<h2>Lab 12-2<a class="headerlink" href="#lab-12-2" title="Permalink to this heading"></a></h2>
<p>Analyze the malware found in the file Lab12-02.exe.</p>
<p><strong>Q1: What is the purpose of this program?</strong></p>
<p>In the imports we see it is importing to write something to another process memory</p>
<img alt="../_images/2q22.png" src="../_images/2q22.png" />
<p>then we see it loading resource maybe it is hiding something in its resources</p>
<img alt="../_images/2q110.png" src="../_images/2q110.png" />
<p>at main we see it first passes ApplicationName and string containing <code class="docutils literal notranslate"><span class="pre">\\svchost.exe</span></code> and calls 40149D
Then pass a handle to the calling (exe) process and calls 40132C</p>
<img alt="../_images/2q32.png" src="../_images/2q32.png" />
<div class="line-block">
<div class="line">we will first check 40149D routine</div>
<div class="line">Looks like it just concatenates the systemdirectory to \svchost output to -&gt; ApplicationName</div>
</div>
<img alt="../_images/2q42.png" src="../_images/2q42.png" />
<div class="line-block">
<div class="line">going to the second call 40132C</div>
</div>
<p>It loads something from resource with name <code class="docutils literal notranslate"><span class="pre">LOCALIZATION</span></code> and type <code class="docutils literal notranslate"><span class="pre">UNICODE</span></code> then allocates place in memory copies the resource to it
and checks if first character or second character doesnt equal to <code class="docutils literal notranslate"><span class="pre">MZ</span></code> (which is start of exe file)
then calls 401000 routine maybe it will decode what is in the resource</p>
<p>Yup it xors the resource file with 65</p>
<img alt="../_images/2q62.png" src="../_images/2q62.png" />
<p>then all the routine returns pointer to the start of allocated memory which contains the decoded resource</p>
<img alt="../_images/2q72.png" src="../_images/2q72.png" />
<p>It then calls 4010EA with parameters decoded resource (lpBuffer) and svchost (lpApplicationName)
| after the call it zeroes the ApplicationName and virtualfrees the decoded resource</p>
<img alt="../_images/2q82.png" src="../_images/2q82.png" />
<p>into 4010EA, it does some checks then starts process with name of module to be executed svchost.exe</p>
<img alt="../_images/2q91.png" src="../_images/2q91.png" />
<p>notice it created the process in suspended state with creationflag set to 0x4 means it used to load a process into memory and suspend it at the entrypoint.</p>
<img alt="../_images/9q9.png" src="../_images/9q9.png" />
<p>with similar overhead discussed in Lab12-01 to allocate space for the decoded resource
and using ZwUnmapViewOfSection to release all memory pointed to by a section passed as a parameter (the svchost)</p>
<img alt="../_images/2q101.png" src="../_images/2q101.png" />
<p>then Once the process is created, the next step is to replace the victim process’s
memory with the malicious executable and uses <code class="docutils literal notranslate"><span class="pre">WriteProcessMemory</span></code> to write each of
the malware sections to the victim process space</p>
<img alt="../_images/2q112.png" src="../_images/2q112.png" />
<p>In the final step, the malware restores the victim process environment so
that the malicious code can run by calling <code class="docutils literal notranslate"><span class="pre">SetThreadContext</span></code> to set the entry
point to point to the malicious code. Finally, ResumeThread is called to initiate
the malware, which has now replaced the victim process.</p>
<img alt="../_images/2q121.png" src="../_images/2q121.png" />
<p>We can gather now it is process replacement (hollowing) malware</p>
<p>the docoded malware is Lab12-03.exe in next section</p>
<p><strong>Q2: How does the launcher program hide execution?</strong></p>
<p>answered above by process hollowing</p>
<p><strong>Q3: Where is the malicious payload stored?</strong></p>
<p>answered above in .rsrc</p>
<p><strong>Q4: How is the malicious payload protected?</strong></p>
<p>answered above by encoding routine</p>
<p><strong>Q5: How are strings protected?</strong></p>
<p>answered above by encoding routine</p>
</section>
<section id="lab-12-3">
<h2>Lab 12-3<a class="headerlink" href="#lab-12-3" title="Permalink to this heading"></a></h2>
<p>Analyze the malware extracted during the analysis of Lab 12-2, or use the file
Lab12-03.exe.</p>
<p><strong>Q1: What is the purpose of this malicious payload?</strong></p>
<p>it creates a hidden console as cmdshow set to 0</p>
<img alt="../_images/3q19.png" src="../_images/3q19.png" />
<p>It creates a hook (so this maybe dll injection by hooking) with threadid set to 0 (meaning all threads are hooked) and idhook set to 13 and procedure at fn and hmod set to the calling process (as getmodulehandle had parameter 0)</p>
<img alt="../_images/3q21.png" src="../_images/3q21.png" />
<p>idhook 13 in MSDN</p>
<p>For WH_KEYBOARD_LL , the events are sent directly to the process
that installed the hook, so the hook will be running in the context of the
process that created it.</p>
<img alt="../_images/3q41.png" src="../_images/3q41.png" />
<p>In fn the hook procedure, it calls a function then calls <code class="docutils literal notranslate"><span class="pre">CallNextHookExA</span></code> which ensures that the next hook procedure in the
call chain gets the message and that the system continues to run properly. (also so victim doesnt get no keyboard input is registered)</p>
<img alt="../_images/3q31.png" src="../_images/3q31.png" />
<p>in 4010C7 routine it creates file <code class="docutils literal notranslate"><span class="pre">practicalmalwareanalysis.log</span></code></p>
<img alt="../_images/3q51.png" src="../_images/3q51.png" />
<p>Then logs the keys pressed into the file while keeping in mind which window and special keys like capslock</p>
<img alt="../_images/3q61.png" src="../_images/3q61.png" />
<img alt="../_images/3q7.png" src="../_images/3q7.png" />
<p><strong>Q2: How does the malicious payload inject itself?</strong></p>
<p>answered above by dll injection with SetWindowsHookExA</p>
<p><strong>Q3: What filesystem residue does this program create?</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">practicalmalwareanalysis.log</span></code></p>
<img alt="../_images/3q111.png" src="../_images/3q111.png" />
</section>
<section id="lab-12-4">
<h2>Lab 12-4<a class="headerlink" href="#lab-12-4" title="Permalink to this heading"></a></h2>
<p>Analyze the malware found in the file Lab12-04.exe.</p>
<p><strong>Q1: What does the code at 0x401000 accomplish?</strong></p>
<p>It get parameter PID, it opens process associated with that pid then calls two functions (global variable ) 40312C and 403128</p>
<img alt="../_images/4q1.png" src="../_images/4q1.png" />
<p>the two functions global variables doesnt contain anything going to their cross refrences where they are set likely
and they got resolved automatically by ida
So it searches the modules for specified PID and gets the modules name
So it searches for winlogon.exe within the pid process if found return 1</p>
<img alt="../_images/4q2.png" src="../_images/4q2.png" />
<p><strong>Q2: Which process has code injected?</strong></p>
<p>Going to cross refrences for 401000. We see it is inside a loop which checks all PIDs  so lets follow the branch where winlogon is found</p>
<img alt="../_images/4q4.png" src="../_images/4q4.png" />
<img alt="../_images/4q3.png" src="../_images/4q3.png" />
<p>it calls 401174 with pid passed, we see it open the process associated with the pid then call the CreateRemoteThread to inject code there</p>
<img alt="../_images/4q5.png" src="../_images/4q5.png" />
<p>winlogon is process being injected</p>
<p><strong>Q3: What DLL is loaded using LoadLibraryA?</strong></p>
<p>sfc_os.dll <a class="reference external" href="https://www.file.net/process/sfc_os.dll.html">https://www.file.net/process/sfc_os.dll.html</a></p>
<p><strong>Q4: What is the fourth argument passed to the CreateRemoteThread call?</strong></p>
<p>address to sfc_os.dll</p>
<img alt="../_images/4q7.png" src="../_images/4q7.png" />
<p>notice it gets the second function from sfc_os.dll we see example here <a class="reference external" href="https://ntcore.com/files/wfp.htm">https://ntcore.com/files/wfp.htm</a> that used it for disabling Windows File Protection</p>
<img alt="../_images/4q6.png" src="../_images/4q6.png" />
<p><strong>Q5: What malware is dropped by the main executable?</strong></p>
<p>Following the flow of main after the above, it create a backup of \system32\wupdmgr.exe then calls another routine</p>
<img alt="../_images/5q1.png" src="../_images/5q1.png" />
<p>into 4011FC, it loads exe file from .rsrc named <code class="docutils literal notranslate"><span class="pre">#101</span></code> type BIN</p>
<img alt="../_images/5q2.png" src="../_images/5q2.png" />
<p>and writes it into \system32\wupdmgr.exe</p>
<img alt="../_images/5q3.png" src="../_images/5q3.png" />
<p>then executes and hides it (with cmdshow set 0)</p>
<img alt="../_images/5q4.png" src="../_images/5q4.png" />
<p><strong>Q6: What is the purpose of this and the dropped malware?</strong></p>
<p>replacing legit update manager with malicious one
it executes first the legit one then the malicious one
.. image:: 5q5.png</p>
<img alt="../_images/5q6.png" src="../_images/5q6.png" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab11/lab11.html" class="btn btn-neutral float-left" title="Practical Malware Analysis - Lab 11" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>