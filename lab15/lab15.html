<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practical Malware Analysis - Lab 15 &mdash; abdelrahmn walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Practical Malware Analysis - Lab 14" href="../lab14/lab14.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahmn walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Practical Malware Analysis - Lab 15</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-15-1">Lab 15-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-15-2">Lab 15-2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-15-3">Lab 15-3</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahmn walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Practical Malware Analysis - Lab 15</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lab15/lab15.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="practical-malware-analysis-lab-15">
<h1>Practical Malware Analysis - Lab 15<a class="headerlink" href="#practical-malware-analysis-lab-15" title="Permalink to this heading"></a></h1>
<p>This chapter’s labs focus on anti-disassembly techniques</p>
<section id="lab-15-1">
<h2>Lab 15-1<a class="headerlink" href="#lab-15-1" title="Permalink to this heading"></a></h2>
<p>Analyze the sample found in the file Lab15-01.exe. This is a command-line
program that takes an argument and prints “Good Job!” if the argument
matches a secret code.</p>
<p><strong>Q1: What anti-disassembly technique is used in this binary?</strong></p>
<p>Opening the malware in ida we notice the red cross-references which are indicators of anti-disassembly</p>
<img alt="../_images/1q116.png" src="../_images/1q116.png" />
<p>here is setting zero flag with conditional jump on zero flag <code class="docutils literal notranslate"><span class="pre">jz</span></code> so it’s just absolute jump but did that way
for ida to wrongly disassemble what the false branch first which is after the jz instruction.
We notice in jz it is jumping to 401010+1 so it’s just a rogue byte inserted between the two</p>
<img alt="../_images/1q26.png" src="../_images/1q26.png" />
<p><strong>Q2: What rogue opcode is the disassembly tricked into disassembling?</strong></p>
<p>Pressing <code class="docutils literal notranslate"><span class="pre">d</span></code> then <code class="docutils literal notranslate"><span class="pre">c</span></code> at 401010+1 , the red xref disappears and the rogue byte is E8 which is the opcode start of call</p>
<img alt="../_images/1q36.png" src="../_images/1q36.png" />
<p><strong>Q3: How many times is this technique used?</strong></p>
<p>4 more times</p>
<img alt="../_images/1q45.png" src="../_images/1q45.png" />
<p><strong>Q4: What command-line argument will cause the program to print “Good Job!”?</strong></p>
<p>After some cleaning then hovering all main function pressing <code class="docutils literal notranslate"><span class="pre">p</span></code> to convert to function we get this normal function</p>
<img alt="../_images/1q55.png" src="../_images/1q55.png" />
<p>Then we can convert to clean psuedocode, It checks first if some argument is passed then proceeds to do some char checks</p>
<img alt="../_images/1q65.png" src="../_images/1q65.png" />
<p>inputting pdq we get the desired output</p>
<img alt="../_images/1q75.png" src="../_images/1q75.png" />
</section>
<section id="lab-15-2">
<h2>Lab 15-2<a class="headerlink" href="#lab-15-2" title="Permalink to this heading"></a></h2>
<p>Analyze the malware found in the file Lab15-02.exe. Correct all anti-disassembly
countermeasures before analyzing the binary in order to answer the questions.</p>
<p><strong>Q1: What URL is initially requested by the program?</strong></p>
<p>Cleaning the anti-disassembly, we see couple of rogue bytes like this cleaning with <code class="docutils literal notranslate"><span class="pre">d</span></code> then <code class="docutils literal notranslate"><span class="pre">c</span></code></p>
<img alt="../_images/2q116.png" src="../_images/2q116.png" />
<img alt="../_images/2q27.png" src="../_images/2q27.png" />
<p>then we see another technique</p>
<img alt="../_images/2q35.png" src="../_images/2q35.png" />
<p>Cleaning the EB byte we get</p>
<img alt="../_images/2q45.png" src="../_images/2q45.png" />
<p>Then we see another anti-disassembly two jz jnz which just means absolute jump but to make ida disassemble the false branch first</p>
<img alt="../_images/2q54.png" src="../_images/2q54.png" />
<p>Cleaned</p>
<img alt="../_images/2q65.png" src="../_images/2q65.png" />
<p>anti-disassembly with valid two instruction (book called this impossible assembly)</p>
<img alt="../_images/2q75.png" src="../_images/2q75.png" />
<p>Cleaned with just converting to code the jmp call location and NOPing others</p>
<img alt="../_images/2q85.png" src="../_images/2q85.png" />
<p>After a lot of similar cleaning we get a clean psuedocode, it gets hostname of the local computer then exchanges some characters (ROT1)</p>
<img alt="../_images/2q94.png" src="../_images/2q94.png" />
<p>Prepares the name, puts it in User-Agent</p>
<img alt="../_images/2q117.png" src="../_images/2q117.png" />
<p>then sends it to <code class="docutils literal notranslate"><span class="pre">http://www.practicalmalwareanalysis.com/bamboo.html</span></code></p>
<img alt="../_images/2q102.png" src="../_images/2q102.png" />
<p>Reads the response cuts what is after Bamboo:: and before ::</p>
<img alt="../_images/2q123.png" src="../_images/2q123.png" />
<p>Calls the string after Bamboo, Then saves the content to <code class="docutils literal notranslate"><span class="pre">Account</span> <span class="pre">Summary.xls.exe</span></code> then executes it</p>
<img alt="../_images/2q132.png" src="../_images/2q132.png" />
<img alt="../_images/2q141.png" src="../_images/2q141.png" />
<p><strong>Q2: How is the User-Agent generated?</strong></p>
<p>Above</p>
<p><strong>Q3: What does the program look for in the page it initially requests?</strong></p>
<p>Above Bamboo</p>
<p><strong>Q4: What does the program do with the information it extracts from
the page?</strong></p>
<p>Above</p>
</section>
<section id="lab-15-3">
<h2>Lab 15-3<a class="headerlink" href="#lab-15-3" title="Permalink to this heading"></a></h2>
<p>Analyze the malware found in the file Lab15-03.exe. At first glance, this binary
appears to be a legitimate tool, but it actually contains more functionality
than advertised.</p>
<p><strong>Q1: How is the malicious code initially called?</strong></p>
<p>At first glance the exe file seems like it enumerates processes</p>
<img alt="../_images/3q113.png" src="../_images/3q113.png" />
<p>Then openprocess each process (gets a handle ) and enumerates all threads and modules</p>
<img alt="../_images/3q23.png" src="../_images/3q23.png" />
<img alt="../_images/3q33.png" src="../_images/3q33.png" />
<p>There is one routine we didn’t see in main checking it then cross-references we find interesting routine</p>
<img alt="../_images/3q53.png" src="../_images/3q53.png" />
<p>with anti-disassembly used here</p>
<img alt="../_images/3q43.png" src="../_images/3q43.png" />
<p>looking up we see SEH manipulating putting custom exception handling routine into SEH, then forcing error by dividing by zero</p>
<img alt="../_images/3q63.png" src="../_images/3q63.png" />
<p>the handler function is misinterpreted as data (because of the retn ida prematurly ends disassembly) pressing <code class="docutils literal notranslate"><span class="pre">c</span></code>, it returns the SEH to normal then does its main purpose</p>
<img alt="../_images/3q72.png" src="../_images/3q72.png" />
<p>anti-disassembly here after we clean it by <code class="docutils literal notranslate"><span class="pre">d</span></code> then <code class="docutils literal notranslate"><span class="pre">c</span></code> at the exact JMP location</p>
<img alt="../_images/3q82.png" src="../_images/3q82.png" />
<p>Cleaned</p>
<img alt="../_images/3q92.png" src="../_images/3q92.png" />
<p>call $+5. This instruction simply calls the location immediately following itself, which results in a pointer to
this memory location being placed on the stack, So 4014E0 is put on the stack</p>
<p>Suspecting this maybe a pointer to some data</p>
<img alt="../_images/3q102.png" src="../_images/3q102.png" />
<p>here it is</p>
<img alt="../_images/3q114.png" src="../_images/3q114.png" />
<p>which is passed to this function, xoring the data with FF</p>
<img alt="../_images/3q152.png" src="../_images/3q152.png" />
<img alt="../_images/3q142.png" src="../_images/3q142.png" />
<p>You can use the tool <a class="reference external" href="https://github.com/OALabs/hexcopy">https://github.com/OALabs/hexcopy</a>- &lt;3 to export only the hex at 403010, or edit -&gt; export -&gt;hex</p>
<img alt="../_images/3q172.png" src="../_images/3q172.png" />
<p>lets also do 403040 data</p>
<img alt="../_images/3q162.png" src="../_images/3q162.png" />
<p><strong>Q2: What does the malicious code do?</strong></p>
<p>it will download a file from <a class="reference external" href="http://www.practicalmalwareanalysis.com/tt.html">http://www.practicalmalwareanalysis.com/tt.html</a> save to spoolsrv.exe and try to run it</p>
<img alt="../_images/3q132.png" src="../_images/3q132.png" />
<p><strong>Q3: What URL does the malware use?</strong></p>
<p>above</p>
<p><strong>Q4: What filename does the malware use?</strong></p>
<p>above</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab14/lab14.html" class="btn btn-neutral float-left" title="Practical Malware Analysis - Lab 14" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>