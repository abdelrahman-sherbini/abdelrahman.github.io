<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practical Malware Analysis - Lab 16 &mdash; abdelrahman walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Practical Malware Analysis - Lab 17" href="../lab17/lab17.html" />
    <link rel="prev" title="Practical Malware Analysis - Lab 15" href="../lab15/lab15.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahman walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab15/lab15.html">Practical Malware Analysis - Lab 15</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Practical Malware Analysis - Lab 16</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-16-1">Lab 16-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-16-2">Lab 16-2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab16-03">Lab16-03</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../lab17/lab17.html">Practical Malware Analysis - Lab 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab18/lab18.html">Practical Malware Analysis - Lab 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab19/lab19.html">Practical Malware Analysis - Lab 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal1/mal1.html">Princess Locker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal2/mal2.html">Blackcat Ransomware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal3/mal3.html">Agent tesla</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SignedUrl/text.html">SignedUrl Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal4/mal4.html">Vidar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../laugh/chals.html">0xLaugh Rev Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal5/agenttesla.html">Agent Tesla Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal6/remcos.html">Remcos Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../confus/agentsmtp.html">Agent tesla (sample1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal8/sample2.html">AndroMeda Malware analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahman walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Practical Malware Analysis - Lab 16</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lab16/lab16.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="practical-malware-analysis-lab-16">
<h1>Practical Malware Analysis - Lab 16<a class="headerlink" href="#practical-malware-analysis-lab-16" title="Link to this heading"></a></h1>
<p>This chapter’s labs focus on anti-debugging techniques</p>
<section id="lab-16-1">
<h2>Lab 16-1<a class="headerlink" href="#lab-16-1" title="Link to this heading"></a></h2>
<p>Analyze the malware found in Lab16-01.exe using a debugger. This is the
same malware as Lab09-01.exe, with added anti-debugging techniques.</p>
<p><strong>Q1: Which anti-debugging techniques does this malware employ?</strong></p>
<p>Into IDA first, First check is check BeingDebugged in struct _PEB (PEB is in fs:30h and BeingDebugged is second parameter)</p>
<img alt="../_images/1q113.png" src="../_images/1q113.png" />
<p>If it is debugged it will self destruct</p>
<img alt="../_images/1q26.png" src="../_images/1q26.png" />
<p>Second check is ProcessHeap(+0x18h) in PEB in The ForceFlags(+0x10h from ProcessHeap) field but for XP</p>
<img alt="../_images/1q36.png" src="../_images/1q36.png" />
<p>Third check is NTGlobalFlag in the PEB at offset 0x68. If the value at this location is 0x70, we know
that we are running in a debugger</p>
<img alt="../_images/1q45.png" src="../_images/1q45.png" />
<p>we notice the checks are in function routines also to be careful</p>
<img alt="../_images/1q55.png" src="../_images/1q55.png" />
<p><strong>Q2: What happens when each anti-debugging technique succeeds?</strong></p>
<p>Self-delete</p>
<p><strong>Q3: How can you get around these anti-debugging techniques?</strong></p>
<p>using ScyllaHide
<a class="reference external" href="https://github.com/x64dbg/ScyllaHide/releases">https://github.com/x64dbg/ScyllaHide/releases</a></p>
<img alt="../_images/1q75.png" src="../_images/1q75.png" />
<p>Or when debuggng force the jumps to the flow for all the instances of anti-debugging</p>
<p><strong>Q4: How do you manually change the structures checked during runtime?</strong></p>
<p>In OllyDbg</p>
<p>Using command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dump</span> <span class="n">fs</span><span class="p">:[</span><span class="mi">30</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span><span class="n">xX</span>
</pre></div>
</div>
<p>we go there then patch the byte :-&gt; right-click -&gt; binary -&gt; Edit change to zero</p>
<p><strong>Q5: Which OllyDbg plug-in will protect you from the anti-debugging techniques
used by this malware?</strong></p>
<p>ScyllaHide</p>
</section>
<section id="lab-16-2">
<h2>Lab 16-2<a class="headerlink" href="#lab-16-2" title="Link to this heading"></a></h2>
<p>Analyze the malware found in Lab16-02.exe using a debugger. The goal of this
lab is to figure out the correct password. The malware does not drop a malicious
payload.</p>
<p><strong>1: What happens when you run Lab16-02.exe from the command line?</strong></p>
<p>Needs a password</p>
<img alt="../_images/1q84.png" src="../_images/1q84.png" />
<p><strong>Q2: What happens when you run Lab16-02.exe and guess the command-line
parameter?</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">Incorrect</span> <span class="pre">password,</span> <span class="pre">Try</span> <span class="pre">again.</span></code></p>
<p><strong>3: What is the command-line password?</strong></p>
<p>Running floss we find it is <a class="reference external" href="mailto:p&#37;&#52;&#48;ss">p<span>&#64;</span>ss</a></p>
<img alt="../_images/1q92.png" src="../_images/1q92.png" />
<p>but it doesn’t work</p>
<p><strong>Q4: Load Lab16-02.exe into IDA Pro. Where in the main function is strncmp
found?</strong></p>
<p>Opening in ida we find this sneaky TLS call</p>
<img alt="../_images/1q103.png" src="../_images/1q103.png" />
<p>where if it gets a handle to OllyDbg window via FindWindows it will exit</p>
<img alt="../_images/2q117.png" src="../_images/2q117.png" />
<p>And there OutputDebugStringA after the previous check</p>
<img alt="../_images/2q124.png" src="../_images/2q124.png" />
<p>the strncmp is in main, typing the offset Str2 gets Incorrect password so the thread created above with StartAddress function may alter the string</p>
<img alt="../_images/2q28.png" src="../_images/2q28.png" />
<p>the StartAddress is a decoding routine with anti-debugging to change password if BeingDebugged is 1 in _PEB</p>
<img alt="../_images/2q118.png" src="../_images/2q118.png" />
<p>Preparing our debugger with the TLS</p>
<img alt="../_images/2q35.png" src="../_images/2q35.png" />
<p>We hit the TLS callback</p>
<img alt="../_images/2q45.png" src="../_images/2q45.png" />
<p>Nulling the return of FindWindow</p>
<img alt="../_images/2q54.png" src="../_images/2q54.png" />
<p>or using ScyllaHide Hooking FindWindow option and the BeingDebugged set to 0, and we get to entrypoint</p>
<img alt="../_images/2q65.png" src="../_images/2q65.png" />
<p>Setting bp at 40123A the strncmp function</p>
<img alt="../_images/2q75.png" src="../_images/2q75.png" />
<p>we see the password <a class="reference external" href="mailto:bzrrp&#37;&#52;&#48;ss">bzrrp<span>&#64;</span>ss</a> but it checks the first 4 chars so the password is bzrr</p>
<img alt="../_images/2q85.png" src="../_images/2q85.png" />
<img alt="../_images/2q95.png" src="../_images/2q95.png" />
<p><strong>Q5: What happens when you load this malware into OllyDbg using the
default settings?</strong></p>
<p>just exits as tls callback is executed first</p>
<p><strong>6: What is unique about the PE structure of Lab16-02.exe?</strong></p>
<img alt="../_images/2q103.png" src="../_images/2q103.png" />
<p><strong>7: Where is the callback located? (Hint: Use CTRL-E in IDA Pro.)</strong></p>
<p>4010610</p>
<img alt="../_images/2q103.png" src="../_images/2q103.png" />
<p><strong>Q8: Which anti-debugging technique is the program using to terminate
immediately in the debugger and how can you avoid this check?</strong></p>
<p><strong>Q9: What is the command-line password you see in the debugger after you
disable the anti-debugging technique?</strong></p>
<p><strong>10: Does the password found in the debugger work on the command line?</strong></p>
<p>No, as StartAddress changes it if BeingDebugged</p>
<p><strong>Q11: Which anti-debugging techniques account for the different passwords in
the debugger and on the command line, and how can you protect
against them?</strong></p>
<p>OutputDebugStringA , TLS, BeingDebugged.</p>
<p>using ScyllaHide or manually force jump for no debugger branch and hook OutputDebugStringA .</p>
</section>
<section id="lab16-03">
<h2>Lab16-03<a class="headerlink" href="#lab16-03" title="Link to this heading"></a></h2>
<p>Analyze the malware in Lab16-03.exe using a debugger. This malware is similar
to Lab09-02.exe, with certain modifications, including the introduction of
anti-debugging techniques. If you get stuck, see Lab 9-2.</p>
<p><strong>Q1: Which strings do you see when using static analysis on the binary?</strong></p>
<p>Focusing only on anti-debugging strings, there is GetTickCount() so maybe this is Timing Check anti-debugging technique</p>
<img alt="../_images/3q115.png" src="../_images/3q115.png" />
<p>and     QueryPerformanceCounter import</p>
<img alt="../_images/3q34.png" src="../_images/3q34.png" />
<p>and if there is a debugger maybe it will Self-delete</p>
<img alt="../_images/3q24.png" src="../_images/3q24.png" />
<p><strong>Q2: What happens when you run this binary?</strong></p>
<p>nothing</p>
<p><strong>Q3: How must you rename the sample in order for it to run properly?</strong></p>
<p>ocl.exe</p>
<img alt="../_images/3q44.png" src="../_images/3q44.png" />
<p><strong>Q4: Which anti-debugging techniques does this malware employ?</strong></p>
<p>QueryPerformanceCounter to check if time elapsed is high through single stepping or normal</p>
<img alt="../_images/3q54.png" src="../_images/3q54.png" />
<p>GetTickCount,  Same</p>
<img alt="../_images/3q64.png" src="../_images/3q64.png" />
<p><strong>Q5: For each technique, what does the malware do if it determines it is
running in a debugger?</strong></p>
<p>For QueryPerformanceCounter it does between the two calls an exception with division by zero with debugger attached if passed exception to user to decide if will pass to the program or debugger,
it will take a lot of time</p>
<img alt="../_images/3q73.png" src="../_images/3q73.png" />
<p>so if time taken is larger than 4B0h (1200) it will set var_118 to 2</p>
<img alt="../_images/3q83.png" src="../_images/3q83.png" />
<p>this routine takes in the ocl.exe string, and does some encoding to it so the output changes as var_118 is used in the encoding</p>
<img alt="../_images/3q93.png" src="../_images/3q93.png" />
<p>in the GetTickCount , it is enclosed between a function call 401000 , and if the time is larger than 1 then it moves edx to location 0 ? and ret  (likely crash)</p>
<img alt="../_images/3q103.png" src="../_images/3q103.png" />
<p>inside 401000 call, the call $+5 will push the next EIP into the stack and jump to plus 5 places, so 401006 will jump to 40100B,
then puts the EIP into eax then into EDI</p>
<img alt="../_images/3q116.png" src="../_images/3q116.png" />
<p>Notice here it will force a division by zero exception</p>
<img alt="../_images/3q122.png" src="../_images/3q122.png" />
<p>with the exception handling being at memory 2Ch which is not possible as they are reserved for system (below 1000) so it will search next handling routine</p>
<img alt="../_images/3q133.png" src="../_images/3q133.png" />
<p>The purpose for this just to make sure that no debugging happens as the exceptions will pass to the user to decide</p>
<p>to avoid all the above we can just pass the exception to the program in x32dbg</p>
<img alt="../_images/3q143.png" src="../_images/3q143.png" />
<p>in the debugger in 4011E0 modifiy this as JMP so we avoid setting this var to 2 as we talked about</p>
<img alt="../_images/3q153.png" src="../_images/3q153.png" />
<p>then we arrive to the encoding which changes the ocl.exe name we should set the executable name to</p>
<img alt="../_images/3q163.png" src="../_images/3q163.png" />
<p>setting breakpoint outside the loop then running, we get the name we should set the executable to is peo.exe</p>
<img alt="../_images/3q173.png" src="../_images/3q173.png" />
<p>So by setting breakpoint at 4015B7, we should arrive safely without the two anti-debugging mentioned above</p>
<img alt="../_images/3q182.png" src="../_images/3q182.png" />
<p>now back to ida after 4015B7, we see 401300 call</p>
<img alt="../_images/3q191.png" src="../_images/3q191.png" />
<p>in 401300 there is another anti-debugging using also timing check with rdtsc with a division by zero in between</p>
<img alt="../_images/3q20.png" src="../_images/3q20.png" />
<p>In pseudo-code, it is better to understand here will do a time check between the exception(the exception doesn’t appear in the pseudo-code but in the assembly it is between them).
and if the time elapsed (number of clock cycles) is more than 0x7A120 it will call 4010E0</p>
<img alt="../_images/3q211.png" src="../_images/3q211.png" />
<p>call 4010E0 attempts to delete the exe</p>
<img alt="../_images/3q221.png" src="../_images/3q221.png" />
<p>so in debugger we just set a breakpoint after 401300 call which does all this, and pass the exceptions to the debugee (but seems it fails so we have to patch JMP) , and we avoid all the anti-debugging used
or patch the conditional jumps to JMP</p>
<p><strong>Q6: Why are the anti-debugging techniques successful in this malware?</strong></p>
<p>The anti-debugging timing checks are successful because the malware
causes and catches an exception that it handles by manipulating the
Structured Exception Handling (SEH) mechanism to include its own
exception handler in between two calls to the timing checking functions.
Exceptions are handled much more slowly in a debugger than outside a
debugger.</p>
<p><strong>Q7: What domain name does this malware use?</strong></p>
<p>Patching all anti-debugging conditional jumps to absolute JMP we get the following
edx:”adg.malwareanalsysisbook.com”</p>
<img alt="../_images/3q25.png" src="../_images/3q25.png" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab15/lab15.html" class="btn btn-neutral float-left" title="Practical Malware Analysis - Lab 15" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../lab17/lab17.html" class="btn btn-neutral float-right" title="Practical Malware Analysis - Lab 17" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>