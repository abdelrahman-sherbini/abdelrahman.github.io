<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practical Malware Analysis - Lab 18 &mdash; abdelrahman walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Practical Malware Analysis - Lab 19" href="../lab19/lab19.html" />
    <link rel="prev" title="Practical Malware Analysis - Lab 17" href="../lab17/lab17.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahman walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab15/lab15.html">Practical Malware Analysis - Lab 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab16/lab16.html">Practical Malware Analysis - Lab 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab17/lab17.html">Practical Malware Analysis - Lab 17</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Practical Malware Analysis - Lab 18</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-18-1">Lab 18-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-18-2">Lab 18-2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-18-3">Lab 18-3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-18-4">Lab 18-4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-18-5">Lab 18-5</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../lab19/lab19.html">Practical Malware Analysis - Lab 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal1/mal1.html">Princess Locker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal2/mal2.html">Blackcat Ransomware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal3/mal3.html">Agent tesla</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SignedUrl/text.html">SignedUrl Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal4/mal4.html">Vidar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../laugh/chals.html">0xLaugh Rev Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal5/agenttesla.html">Agent Tesla Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal6/remcos.html">Remcos Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../confus/agentsmtp.html">Agent tesla (sample1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal8/sample2.html">AndroMeda Malware analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahman walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Practical Malware Analysis - Lab 18</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lab18/lab18.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="practical-malware-analysis-lab-18">
<h1>Practical Malware Analysis - Lab 18<a class="headerlink" href="#practical-malware-analysis-lab-18" title="Link to this heading"></a></h1>
<p>Your goal for the labs in this chapter is simply to unpack the code for further
analysis. For each lab, you should try to unpack the code so that other static
analysis techniques can be used. While you may be able to find an automated
unpacker that will work with some of these labs, automated unpackers won’t
help you learn the skills you need when you encounter custom packers. Also,
once you master unpacking, you may be able to manually unpack a file in less
time than it takes to find, download, and use an automated unpacker.
Each lab is a packed version of a lab from a previous chapter. Your task in
each case is to unpack the lab and identify the chapter in which it appeared.
The files are Lab18-01.exe through Lab18-05.exe.</p>
<section id="lab-18-1">
<h2>Lab 18-1<a class="headerlink" href="#lab-18-1" title="Link to this heading"></a></h2>
<p>Openning it in exeinfo we see it is packed with UPX so we could unpack it with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UPX</span> <span class="o">-</span><span class="n">d</span> <span class="n">file</span><span class="o">.</span><span class="n">exe</span>
</pre></div>
</div>
<img alt="../_images/1q115.png" src="../_images/1q115.png" />
<p>but i will unpack it manually, Open it in IDA we get this</p>
<img alt="../_images/1q28.png" src="../_images/1q28.png" />
<p>It has very few libraries (as it is packed) with one standing out urlmon and since it is using VirtualAlloc we can use it for hardware read breakpoint for the place in memory it will write the malware to</p>
<img alt="../_images/1q57.png" src="../_images/1q57.png" />
<p>the urlmon is used in a packed section</p>
<img alt="../_images/1q65.png" src="../_images/1q65.png" />
<p>The graph view of the unpacking stub is dreadful, i will look for the tail jumps</p>
<img alt="../_images/1q38.png" src="../_images/1q38.png" />
<p>Something interesting a jump for location over 0x8000 away, also before it some weird instructions (like cmp esp,eax), so this is likely our tail jump opening in x32dbg to test it</p>
<img alt="../_images/1q47.png" src="../_images/1q47.png" />
<p>The unpacking stub started with pushad, looking at the stack see interesting memory address setting another hardware read breakpoint there (first on the stack click read memory in dump then in dump set the breakpoint)</p>
<img alt="../_images/1q76.png" src="../_images/1q76.png" />
<p>We arrive near out suspected tail jump</p>
<img alt="../_images/1q93.png" src="../_images/1q93.png" />
<p>and here is the memory dump,(notice at stack there is MZ which is the start of exe file)</p>
<img alt="../_images/1q85.png" src="../_images/1q85.png" />
<p>opening scylla plugin in x32dbg then type memory that will be jumped to as our OEP and then click on IAT Autosearch (to autosearch for IAT import address table)</p>
<img alt="../_images/1q104.png" src="../_images/1q104.png" />
<p>clicking yes, it was successful</p>
<img alt="../_images/1q116.png" src="../_images/1q116.png" />
<p>Then click Get imports then clicking Dump</p>
<img alt="../_images/1q123.png" src="../_images/1q123.png" />
<p>we find our malware functional with full imports</p>
<img alt="../_images/1q131.png" src="../_images/1q131.png" />
<p>the malware is the same as Lab14-01.exe</p>
<img alt="../_images/1q142.png" src="../_images/1q142.png" />
</section>
<section id="lab-18-2">
<h2>Lab 18-2<a class="headerlink" href="#lab-18-2" title="Link to this heading"></a></h2>
<p>Running the malware in peid we see it is packed with FSG 1.0</p>
<img alt="../_images/1q152.png" src="../_images/1q152.png" />
<p>looking at imports</p>
<img alt="../_images/1q162.png" src="../_images/1q162.png" />
<p>since i didnt notice a tail jump, i will follow the getprocadress breakpoint technique, setting bp at getprocadress in x32dbg then work backwards to find the OEP (as that function is used for getting addresses of the libraries that will be used), i also set another breakpoint at this pushed memory address</p>
<img alt="../_images/2q120.png" src="../_images/2q120.png" />
<img alt="../_images/2q210.png" src="../_images/2q210.png" />
<p>We hit the hardware read breakpoint</p>
<img alt="../_images/2q37.png" src="../_images/2q37.png" />
<p>suspecting this maybe our OEP but no it failed to IAT auto search</p>
<img alt="../_images/2q47.png" src="../_images/2q47.png" />
<p>Looks like this isn’t the memory we want, so keep running till we find our break at getprocadress</p>
<img alt="../_images/2q56.png" src="../_images/2q56.png" />
<p>Reading the around code we find some pushed data (with MZ the start of exe file) then calling an address suspecting that may be our OEP</p>
<img alt="../_images/2q1111.png" src="../_images/2q1111.png" />
<p>we find our Lab07-02.exe but with wrong entry point</p>
<img alt="../_images/2q126.png" src="../_images/2q126.png" />
<p>Using ollydbg, we can easily just find OEP by section hop trace over, then dump debugged process</p>
<img alt="../_images/2q143.png" src="../_images/2q143.png" />
<p>and we get the same exe</p>
<img alt="../_images/2q152.png" src="../_images/2q152.png" />
</section>
<section id="lab-18-3">
<h2>Lab 18-3<a class="headerlink" href="#lab-18-3" title="Link to this heading"></a></h2>
<p>In peid it is packed using PECompact</p>
<img alt="../_images/3q118.png" src="../_images/3q118.png" />
<p>Imports the libraries i will break GetProcAddress and VirtualAlloc</p>
<img alt="../_images/3q27.png" src="../_images/3q27.png" />
<p>opening it in x32dbg, at the start we see pushad</p>
<img alt="../_images/3q45.png" src="../_images/3q45.png" />
<p>In the stack, i set bp at 18FF7C at the stack, and 7EFDE000, 76F43368 in memory</p>
<img alt="../_images/3q35.png" src="../_images/3q35.png" />
<p>our bp at 18FF7C is hit (with popad)</p>
<img alt="../_images/3q119.png" src="../_images/3q119.png" />
<p>Hitting we step over we get this which is likely our OEP (as retn pops what is on stack then jumps to it)</p>
<img alt="../_images/3q123.png" src="../_images/3q123.png" />
<p>we can dump it with scylla  but Imports failed to get it</p>
<img alt="../_images/3q134.png" src="../_images/3q134.png" />
<p>Going over breakpoint GetProcAddress we can get the imports, found also its place in memory</p>
<img alt="../_images/3q74.png" src="../_images/3q74.png" />
<p>and we get the Lab09-02.exe</p>
<img alt="../_images/3q104.png" src="../_images/3q104.png" />
</section>
<section id="lab-18-4">
<h2>Lab 18-4<a class="headerlink" href="#lab-18-4" title="Link to this heading"></a></h2>
<p>exeinfo shows it is packed with Aspack v2.12</p>
<img alt="../_images/4q22.png" src="../_images/4q22.png" />
<p>imports shows quite important information</p>
<img alt="../_images/4q12.png" src="../_images/4q12.png" />
<p>I set bp at GetProcAddress as usual, we get hit before entrypoint</p>
<img alt="../_images/4q32.png" src="../_images/4q32.png" />
<p>and here it is preparing imports for the packed malware</p>
<img alt="../_images/4q42.png" src="../_images/4q42.png" />
<p>and we can see where it is getting its data from the stack</p>
<img alt="../_images/4q62.png" src="../_images/4q62.png" />
<p>Then we hit our entrypoint with pushad</p>
<img alt="../_images/4q72.png" src="../_images/4q72.png" />
<p>so i set hardware breakpoint on that unusual memory in the stack when it is popped</p>
<img alt="../_images/4q8.png" src="../_images/4q8.png" />
<p>we get a hit</p>
<img alt="../_images/4q9.png" src="../_images/4q9.png" />
<p>Stepping over we see our tail jump</p>
<img alt="../_images/4q10.png" src="../_images/4q10.png" />
<p>Trying scylla here with the jump address but fail</p>
<img alt="../_images/4q111.png" src="../_images/4q111.png" />
<p>Viewing it in memory (we could dump it from here)</p>
<img alt="../_images/4q13.png" src="../_images/4q13.png" />
<p>Stepping over the retn so we go to our tail jump then try scylla</p>
<img alt="../_images/4q14.png" src="../_images/4q14.png" />
<p>dumped, we see the same exe as Lab09-01.exe</p>
<img alt="../_images/4q15.png" src="../_images/4q15.png" />
</section>
<section id="lab-18-5">
<h2>Lab 18-5<a class="headerlink" href="#lab-18-5" title="Link to this heading"></a></h2>
<p>DIE shows it is packed with UPACK</p>
<img alt="../_images/5q11.png" src="../_images/5q11.png" />
<p>PStudio shows zero imports</p>
<img alt="../_images/5q21.png" src="../_images/5q21.png" />
<p>We hit the entrypoint with a few pushes</p>
<img alt="../_images/5q31.png" src="../_images/5q31.png" />
<p>adding hardware breakpoint at those stack addresses (waiting for pop for the unpacking stub to finish)</p>
<img alt="../_images/5q41.png" src="../_images/5q41.png" />
<img alt="../_images/5q51.png" src="../_images/5q51.png" />
<p>we hit one of breakpoints</p>
<img alt="../_images/5q61.png" src="../_images/5q61.png" />
<p>Stepping over we see Something interesting pushing ebx then calling ebp</p>
<img alt="../_images/5q7.png" src="../_images/5q7.png" />
<p>Looking at ebx</p>
<img alt="../_images/5q8.png" src="../_images/5q8.png" />
<p>calling scylla on that address</p>
<img alt="../_images/5q9.png" src="../_images/5q9.png" />
<p>but we get incomplete exe so returning to x32 for next breakpoint</p>
<img alt="../_images/5q10.png" src="../_images/5q10.png" />
<p>calling scylla for that memory address</p>
<img alt="../_images/5q111.png" src="../_images/5q111.png" />
<p>it is the same as Lab07-01.exe</p>
<img alt="../_images/5q12.png" src="../_images/5q12.png" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab17/lab17.html" class="btn btn-neutral float-left" title="Practical Malware Analysis - Lab 17" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../lab19/lab19.html" class="btn btn-neutral float-right" title="Practical Malware Analysis - Lab 19" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>