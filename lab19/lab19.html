<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practical Malware Analysis - Lab 19 &mdash; abdelrahmn walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Practical Malware Analysis - Lab 18" href="../lab18/lab18.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahmn walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab15/lab15.html">Practical Malware Analysis - Lab 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab16/lab16.html">Practical Malware Analysis - Lab 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab17/lab17.html">Practical Malware Analysis - Lab 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab18/lab18.html">Practical Malware Analysis - Lab 18</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Practical Malware Analysis - Lab 19</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-19-1">Lab 19-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Lab 19-1</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahmn walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Practical Malware Analysis - Lab 19</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lab19/lab19.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="practical-malware-analysis-lab-19">
<h1>Practical Malware Analysis - Lab 19<a class="headerlink" href="#practical-malware-analysis-lab-19" title="Permalink to this heading"></a></h1>
<p>In these labs, we’ll use what we’ve covered in Chapter 19 to analyze samples
inspired by real shellcode. Because a debugger cannot easily load and run
shellcode directly, we’ll use a utility called shellcode_launcher.exe to dynamically
analyze shellcode binaries. You’ll find instructions on how to use this utility
in Chapter 19 and in the detailed analyses in Appendix C.</p>
<section id="lab-19-1">
<h2>Lab 19-1<a class="headerlink" href="#lab-19-1" title="Permalink to this heading"></a></h2>
<p>Analyze the file Lab19-01.bin using shellcode_launcher.exe.</p>
<p><strong>Q1: How is the shellcode encoded?</strong></p>
<p>Opening in HxD, we can see the NOP sled 41 (opcode for inc ecx) which are used typically in bufferoverflows</p>
<img alt="../_images/1q120.png" src="../_images/1q120.png" />
<p>After that ,we got 0x18Dh(397 in decimal) in ecx then jmp 21F</p>
<img alt="../_images/1q210.png" src="../_images/1q210.png" />
<p>Which first calls loc_208 (which is the decoding routine), the decoding routine puts the next EIP points to after the call to esi then to edi(safe copy puts that again in the stack) and to al(via lodsb) and to dl
dl = [SI]- 41
shl dl, 4
al = (([ESI] ) - 41)+ dl =</p>
<p>then store EAX to [EDI]</p>
<img alt="../_images/1q310.png" src="../_images/1q310.png" />
<p>Running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shellcode_launcher</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">i</span> <span class="n">Lab19</span><span class="o">-</span><span class="mf">01.</span><span class="n">bin</span> <span class="o">-</span><span class="n">bp</span>
</pre></div>
</div>
<p>Then setting x32dbg as JIT</p>
<img alt="../_images/1q49.png" src="../_images/1q49.png" />
<p>here is a code to decode it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sub_208</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">esi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edi</span> <span class="o">=</span> <span class="n">esi</span>

    <span class="k">while</span> <span class="n">esi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">al</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">esi</span><span class="p">]</span>
        <span class="n">esi</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">dl</span> <span class="o">=</span> <span class="n">al</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">dl</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>

        <span class="n">al</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">esi</span><span class="p">]</span>
        <span class="n">esi</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">al</span> <span class="o">=</span> <span class="n">al</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">dl</span>

        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">al</span><span class="p">)</span>
        <span class="n">edi</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

<span class="n">input_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;494A4F4649424F4D45414141414141414F4A444441424141414146474648494C48454345414D44425050504D44424D414B4D44494F414845414B4D424D50414E41424D484F4A4F50505050505049504A50494650464F4D43414541414741494C474D4345434543494C4546444D494C46454146484941424F4B494C454B4249494C464B434141424F4C4F44434B454A494C4445494C41424F4F46474F494C4C50505050445050444C45454345434948464F4D494C464B434541424F4C4747494C414D454C494C464B424D41424F4C494C4145494C41424F494F4A414341414141414142424D41494A45454345424D47424D4341494141464744424D414745494C4541444149464D4148494150494C4541414D494C4841424D4B4E494C454141494F4A414641414141414F4A504C505050504650464F4D44464C4F494E4A5050505049504A4D43474949454F414F4F4D46434F494949415050504950494A4546504D47494D42484A4F464C4946434F4948435050505049444C45454345434948464F4D494C464B434541424F4C4747494C414D454C494C464B424D41424F4C494C4145494C41424F494F4A414341414141414142424D41494A45454345424D47424D4341494141464744424D414745494C4541444149464D4148494150494C4541414D494C4841424D4B4E494C454141494F4A414641414141414F4A504C505050504650464F4D44464C4F494E4A5050505049504A4D43474949454F414F4F4D46434F494949415050504950494A4546504D47494D42484A4F464C4946434F4948435050505049444C45454345434948464F4D494C464B434541424F4C4747494C414D454C494C464B424D41424F4C494C4145494C41424F494F4A414341414141414142424D41494A45454345424D47424D4341494141464744424D41474549&#39;</span><span class="p">)</span>

<span class="n">output_data</span> <span class="o">=</span> <span class="n">sub_208</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">output_data</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</pre></div>
</div>
<p><strong>Q2: Which functions does the shellcode manually import?</strong></p>
<p>Running this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scdbg</span> <span class="o">-</span><span class="n">f</span> <span class="n">Lab19</span><span class="o">-</span><span class="mf">01.</span><span class="n">bin</span> <span class="o">-</span><span class="n">findsc</span>
</pre></div>
</div>
<img alt="../_images/1q59.png" src="../_images/1q59.png" />
<p><strong>Q3: What network host does the shellcode communicate with?</strong></p>
<p><strong>Q4: What filesystem residue does the shellcode leave?</strong></p>
<p><strong>Q5: What does the shellcode do?</strong></p>
</section>
<section id="id1">
<h2>Lab 19-1<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<p>The file Lab19-02.exe contains a piece of shellcode that will be injected into
another process and run. Analyze this file.</p>
<p><strong>Q1: What process is injected with the shellcode?</strong></p>
<p>Analysis of exe in ida, first it starts with excalating privilege</p>
<img alt="../_images/2q128.png" src="../_images/2q128.png" />
<p>then, it pushes argument Data to call 401000 which is used later , so that call puts something in Data</p>
<img alt="../_images/2q212.png" src="../_images/2q212.png" />
<p>401000 opens registery “HKEY_CLASSES_ROOTHTTPshellopencommand”. This registry key configures your systems default browser, and the program specified</p>
<img alt="../_images/2q39.png" src="../_images/2q39.png" />
<p>queries the value there and puts it into Data</p>
<img alt="../_images/2q49.png" src="../_images/2q49.png" />
<img alt="../_images/2q58.png" src="../_images/2q58.png" />
<p>then calls 401180 with that Data (which contains the default browser) and another parameter processID which is used later</p>
<img alt="../_images/2q1112.png" src="../_images/2q1112.png" />
<p>in 401180 it create process with the Data and put the PID to processID</p>
<img alt="../_images/2q68.png" src="../_images/2q68.png" />
<p>then calls 401230(likely the injector) with the PID and an offset (which is likely the shellcode)</p>
<img alt="../_images/2q78.png" src="../_images/2q78.png" />
<p>401230 it process injects the default browser with lpBaseAddress which the offset given</p>
<img alt="../_images/2q88.png" src="../_images/2q88.png" />
<p>going to the offset we see undefined data</p>
<img alt="../_images/2q97.png" src="../_images/2q97.png" />
<p>pressing c, we see the unpacker which gets address starting from 407048 (with call then pop) then loops over this data XORing it with 0xE7 for range 0x18F</p>
<img alt="../_images/2q105.png" src="../_images/2q105.png" />
<p>xor Then saving to file and open it in scdbg(failed have to be dynamic analysis)</p>
<img alt="../_images/2q129.png" src="../_images/2q129.png" />
<img alt="../_images/2q134.png" src="../_images/2q134.png" />
<p>opening in x32dbg and set bp and writeprocessmemory to dump the injected shellcode we see our shellcode at 407030 at edx</p>
<img alt="../_images/2q144.png" src="../_images/2q144.png" />
<p>following in dump</p>
<img alt="../_images/2q153.png" src="../_images/2q153.png" />
<p>we get the imports</p>
<img alt="../_images/2q163.png" src="../_images/2q163.png" />
<p><strong>Q2: Where is the shellcode located?</strong></p>
<p><strong>Q3: How is the shellcode encoded?</strong></p>
<p><strong>Q4: Which functions does the shellcode manually import?</strong></p>
<p><strong>Q5: What network hosts does the shellcode communicate with?</strong></p>
<p><strong>Q6: What does the shellcode do?</strong></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab18/lab18.html" class="btn btn-neutral float-left" title="Practical Malware Analysis - Lab 18" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>