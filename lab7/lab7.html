<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practical Malware Analysis - Lab 7 &mdash; abdelrahman walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Practical Malware Analysis - Lab 9" href="../lab9/lab9.html" />
    <link rel="prev" title="Practical Malware Analysis - Lab 6" href="../lab6/lab6.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahman walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Practical Malware Analysis - Lab 7</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-7-1">Lab 7-1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-7-2">Lab 7-2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-7-3">Lab 7-3</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab15/lab15.html">Practical Malware Analysis - Lab 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab16/lab16.html">Practical Malware Analysis - Lab 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab17/lab17.html">Practical Malware Analysis - Lab 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab18/lab18.html">Practical Malware Analysis - Lab 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab19/lab19.html">Practical Malware Analysis - Lab 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal1/mal1.html">Princess Locker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal2/mal2.html">Blackcat Ransomware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal3/mal3.html">Agent tesla</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SignedUrl/text.html">SignedUrl Hub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahman walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Practical Malware Analysis - Lab 7</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lab7/lab7.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="practical-malware-analysis-lab-7">
<h1>Practical Malware Analysis - Lab 7<a class="headerlink" href="#practical-malware-analysis-lab-7" title="Link to this heading"></a></h1>
<section id="lab-7-1">
<h2>Lab 7-1<a class="headerlink" href="#lab-7-1" title="Link to this heading"></a></h2>
<p>Analyze the malware found in the file Lab07-01.exe.</p>
<p><strong>Q1: How does this program ensure that it continues running (achieves persistence) when the computer is restarted?</strong></p>
<p>Into the main function it calls StartServiceCtrlDispatcherA to Connect the main thread of a service process to the service control manager.</p>
<img alt="../_images/q110.png" src="../_images/q110.png" />
<p>it passes function 401040 to the control manager going into it, it starts a mutex (to ensure only one instance running of the malware) and run startservice with
startype 2 (which is autostart at pc startup)</p>
<img alt="../_images/q1111.png" src="../_images/q1111.png" />
<img alt="../_images/q121.png" src="../_images/q121.png" />
<p><strong>Q2: Why does this program use a mutex?</strong></p>
<p>To ensure ensure only one instance running of the malware. and using hardcoded mutex name because mutex’s name must be consistent if it’s used by two processes that aren’t
communicating in any other way.</p>
<img alt="../_images/q24.png" src="../_images/q24.png" />
<p><strong>Q3: What is a good host-based signature to use for detecting this program?</strong></p>
<p>We can use command <code class="docutils literal notranslate"><span class="pre">sc</span> <span class="pre">qc</span> <span class="pre">Malservice</span></code>
or check hardcoded string for the mutex HGL345</p>
<p><strong>Q4: What is a good network-based signature for detecting this malware?</strong></p>
<p>It creates a thread with a function offset passed into it</p>
<img alt="../_images/q212.png" src="../_images/q212.png" />
<p>In the function it opens a url <a class="reference external" href="http://www.malwareanalysisbook.com">http://www.malwareanalysisbook.com</a> with User-agent Internet explorer 8 that makes good network-based signature</p>
<img alt="../_images/q222.png" src="../_images/q222.png" />
<p><strong>Q5: What is the purpose of this program?</strong></p>
<p>So it calls <code class="docutils literal notranslate"><span class="pre">Waitforsingleobject</span></code> and passes to it handle for set waitable timer to wait for certain time which is 2100 (834h in 4010DE)</p>
<img alt="../_images/q32.png" src="../_images/q32.png" />
<p>when it reaches that year 2100 it will start a thread in a loop for 20 times</p>
<img alt="../_images/q313.png" src="../_images/q313.png" />
<p>in that loop that function to open a url <a class="reference external" href="http://www.malwareanalysisbook.com">http://www.malwareanalysisbook.com</a> with User-agent Internet explorer 8
which may by a setup for a zombie botnet for dos</p>
<img alt="../_images/q222.png" src="../_images/q222.png" />
<p><strong>Q6: When will this program finish executing?</strong></p>
<div class="line-block">
<div class="line">At the start of year 2100 it will create infinite loop with 20 threads to open the url</div>
<div class="line">so never</div>
</div>
</section>
<section id="lab-7-2">
<h2>Lab 7-2<a class="headerlink" href="#lab-7-2" title="Link to this heading"></a></h2>
<p>Analyze the malware found in the file Lab07-02.exe.</p>
<p><strong>Q1: How does this program achieve persistence?</strong></p>
<p><strong>Q2: What is the purpose of this program?</strong></p>
<p>It utilizes COM object because of the indicators <code class="docutils literal notranslate"><span class="pre">OleInitialize</span></code> , <code class="docutils literal notranslate"><span class="pre">CoCreateInstance</span></code></p>
<img alt="../_images/qq1.png" src="../_images/qq1.png" />
<p>By going into our register at <code class="docutils literal notranslate"><span class="pre">Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID</span></code> and search for
2DF01 clsid that is used in the COM object
we see it is Internet explorer</p>
<img alt="../_images/qq12.png" src="../_images/qq12.png" />
<img alt="../_images/qq11.png" src="../_images/qq11.png" />
<p>Then a string ‘<a class="reference external" href="http://www.malwareanalysisbook.com/ad.html">http://www.malwareanalysisbook.com/ad.html</a>’ is passed to the functionality maybe adware</p>
<p>so now we know it opens the site using internet eplorer</p>
<p><strong>Q3: When will this program finish executing?</strong></p>
<p>It will unintialize the COM object normally after finishes its function to open the adware</p>
<img alt="../_images/qq3.png" src="../_images/qq3.png" />
</section>
<section id="lab-7-3">
<h2>Lab 7-3<a class="headerlink" href="#lab-7-3" title="Link to this heading"></a></h2>
<p>For this lab, we obtained the malicious executable, Lab07-03.exe, and DLL,
Lab07-03.dll, prior to executing. This is important to note because the malware
might change once it runs. Both files were found in the same directory
on the victim machine. If you run the program, you should ensure that both
files are in the same directory on the analysis machine. A visible IP string
beginning with 127 (a loopback address) connects to the local machine. (In
the real version of this malware, this address connects to a remote machine,
but we’ve set it to connect to localhost to protect you.)</p>
<p><code class="docutils literal notranslate"><span class="pre">WARNING</span> <span class="pre">This</span> <span class="pre">lab</span> <span class="pre">may</span> <span class="pre">cause</span> <span class="pre">considerable</span> <span class="pre">damage</span> <span class="pre">to</span> <span class="pre">your</span> <span class="pre">computer</span> <span class="pre">and</span> <span class="pre">may</span> <span class="pre">be</span> <span class="pre">difficult</span> <span class="pre">to</span>
<span class="pre">remove</span> <span class="pre">once</span> <span class="pre">installed.</span> <span class="pre">Do</span> <span class="pre">not</span> <span class="pre">run</span> <span class="pre">this</span> <span class="pre">file</span> <span class="pre">without</span> <span class="pre">a</span> <span class="pre">virtual</span> <span class="pre">machine</span> <span class="pre">with</span> <span class="pre">a</span> <span class="pre">snapshot</span>
<span class="pre">taken</span> <span class="pre">prior</span> <span class="pre">to</span> <span class="pre">execution.</span></code></p>
<p>This lab may be a bit more challenging than previous ones. You’ll need
to use a combination of static and dynamic methods, and focus on the big
picture in order to avoid getting bogged down by the details.</p>
<hr class="docutils" />
<p>Into the main function IoCs:</p>
<p>It opens <code class="docutils literal notranslate"><span class="pre">C:\\Windows\\System32\\Kerne132.dll</span></code> and maps it into memory (then any changes there will be reflected to the disk)
And opens <code class="docutils literal notranslate"><span class="pre">Lab07-03.dll</span></code> the same way</p>
<img alt="../_images/q7.png" src="../_images/q7.png" />
<p>After some processing it copies <code class="docutils literal notranslate"><span class="pre">Lab07-03.dll</span></code> into <code class="docutils literal notranslate"><span class="pre">C:\\Windows\\System32\\Kerne132.dll</span></code> (notice 132 not l32)</p>
<img alt="../_images/q71.png" src="../_images/q71.png" />
<p>And if successful it will likely loop through <code class="docutils literal notranslate"><span class="pre">C:\\*</span></code> in function 4011E0</p>
<img alt="../_images/q72.png" src="../_images/q72.png" />
<p>it iterates through the files</p>
<img alt="../_images/q73.png" src="../_images/q73.png" />
<p>and after file names processing it searches for .exe files</p>
<img alt="../_images/q74.png" src="../_images/q74.png" />
<p>If it finds .exe files it then calls a subroutine with the file name</p>
<img alt="../_images/q75.png" src="../_images/q75.png" />
<p>It maps the file into memory</p>
<img alt="../_images/q76.png" src="../_images/q76.png" />
<p>It loops through the file mapped in memory and searches for string2 which is Kernel32.dll and
if it finds it in the mapping it replaces it with dword_403010 which contains <code class="docutils literal notranslate"><span class="pre">kerne132.dll</span></code> (notice 132 not l32) in the <code class="docutils literal notranslate"><span class="pre">qmemcpy</span></code></p>
<img alt="../_images/q77.png" src="../_images/q77.png" />
<p>Going into the Lab07-03.dll dllMain function
First it starts a mutex to ensure only one instance of it running</p>
<img alt="../_images/q78.png" src="../_images/q78.png" />
<p>Then it connects to ip <code class="docutils literal notranslate"><span class="pre">127.26.152.13</span></code></p>
<img alt="../_images/q79.png" src="../_images/q79.png" />
<p>It is likely here checking for connection like <code class="docutils literal notranslate"><span class="pre">send</span> <span class="pre">ping</span> <span class="pre">pong</span></code> to recieve data</p>
<img alt="../_images/q710.png" src="../_images/q710.png" />
<img alt="../_images/q711.png" src="../_images/q711.png" />
<p>And then executes what it recieves</p>
<img alt="../_images/q712.png" src="../_images/q712.png" />
<p><strong>Q1: How does this program achieve persistence to ensure that it continues running when the computer is restarted?</strong></p>
<p>By overwriting files with <code class="docutils literal notranslate"><span class="pre">.exe</span></code> in C:\* to use the kerne132.dll which is Lab07-03.dll instead of kernel32.dll</p>
<p><strong>Q2: What are two good host-based signatures for this malware?</strong></p>
<p>file <code class="docutils literal notranslate"><span class="pre">C:\\Windows\\System32\\Kerne132.dll</span></code></p>
<p>Mutex with hardcoded string <code class="docutils literal notranslate"><span class="pre">SADFHUHF</span></code></p>
<p><strong>Q3: What is the purpose of this program?</strong></p>
<p>To inject malicious dll for C&amp;C url into all exe files under C</p>
<p><strong>Q4: How could you remove this malware once it is installed?</strong></p>
<p>By reversing the logic used going through all files under C and then mapping it into memory searching for kerne132.dll and
changing it into the real kernel32.dll
Or easier change kerne132 to be kernel32 in <code class="docutils literal notranslate"><span class="pre">C:\\Windows\\System32\\Kerne132.dll</span></code></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab6/lab6.html" class="btn btn-neutral float-left" title="Practical Malware Analysis - Lab 6" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../lab9/lab9.html" class="btn btn-neutral float-right" title="Practical Malware Analysis - Lab 9" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>