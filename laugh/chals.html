<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>0xLaugh Rev Challenges &mdash; abdelrahman walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Vidar" href="../mal4/mal4.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahman walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab15/lab15.html">Practical Malware Analysis - Lab 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab16/lab16.html">Practical Malware Analysis - Lab 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab17/lab17.html">Practical Malware Analysis - Lab 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab18/lab18.html">Practical Malware Analysis - Lab 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab19/lab19.html">Practical Malware Analysis - Lab 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal1/mal1.html">Princess Locker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal2/mal2.html">Blackcat Ransomware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal3/mal3.html">Agent tesla</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SignedUrl/text.html">SignedUrl Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal4/mal4.html">Vidar</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">0xLaugh Rev Challenges</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#nano">nano</a></li>
<li class="toctree-l2"><a class="reference internal" href="#easy-login">easy login</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahman walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">0xLaugh Rev Challenges</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/laugh/chals.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="xlaugh-rev-challenges">
<h1>0xLaugh Rev Challenges<a class="headerlink" href="#xlaugh-rev-challenges" title="Link to this heading"></a></h1>
<section id="nano">
<h2>nano<a class="headerlink" href="#nano" title="Link to this heading"></a></h2>
<p>nano is an elf 64bit file so we will use linux with ida in analyzing it</p>
<p>It comes with simple antidisassembly as discussed in PMA lab15 we can replace the bytes from 134E to 1352 with NOPs
replace 74 03 75 01 E8 with 90’s</p>
<img alt="../_images/Screenshot_116.png" src="../_images/Screenshot_116.png" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">fixed</span><span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;nano&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x74\x03\x75\x01\xe8</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x90\x90\x90\x90\x90</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">open</span><span class="p">(</span><span class="s2">&quot;cleaned_nano&quot;</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fixed</span><span class="p">)</span>
</pre></div>
</div>
<p>first is a cheesy check function</p>
<img alt="../_images/Screenshot_217.png" src="../_images/Screenshot_217.png" />
<p>it is XOR and we are given key and flag and if we xor we get the flag?</p>
<img alt="../_images/Screenshot_416.png" src="../_images/Screenshot_416.png" />
<p>No we get watch a rickroll video</p>
<img alt="../_images/Screenshot_510.png" src="../_images/Screenshot_510.png" />
<p>Looking again at ida we see it attempts to read from address zero with gives SIGSEGV (segmentation fault)</p>
<img alt="../_images/Screenshot_614.png" src="../_images/Screenshot_614.png" />
<p>Which we get when we run gdb-peda with breaking at check function <cite>break check</cite></p>
<img alt="../_images/Screenshot_76.png" src="../_images/Screenshot_76.png" />
<p>Looking at ida, note that the check happens in a child process</p>
<img alt="../_images/Screenshot_86.png" src="../_images/Screenshot_86.png" />
<p>And the parent process catches that exception using waitpid status loc, if there is error break and if child exited with specific status do the following
The status is WTERMSIG(status) which checks SEGSEGV from <a class="reference external" href="https://linux.die.net/man/2/waitpid">here</a></p>
<img alt="../_images/Screenshot_95.png" src="../_images/Screenshot_95.png" />
<p>it calculates some values (note pid[1] is just zero) the calls a ptrace syscall which has ability to trace a pid and get registers and set registers</p>
<img alt="../_images/Screenshot_106.png" src="../_images/Screenshot_106.png" />
<img alt="../_images/Screenshot_117.png" src="../_images/Screenshot_117.png" />
<p>following same or’ed value in ptrace calls we see the value is set r12</p>
<img alt="../_images/Screenshot_125.png" src="../_images/Screenshot_125.png" />
<img alt="../_images/Screenshot_135.png" src="../_images/Screenshot_135.png" />
<p>Which is the register that contains our KEY, so we write a python script to replicate the replacing of KEY bytes then xor it with the FLAG</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pwn</span>

<span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;0C 5C 60 20 69 63 64 0F 4F 1E 33 3A 68 2A 7C D9 D5 D0 C9 E7 C3 F0 BC AB 9B D7 98 8B AF B0 F8 47 49 16 49 68&quot;</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">37</span><span class="p">):</span>

    <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">^</span><span class="mh">0xCA</span>
    <span class="n">v9</span> <span class="o">^=</span><span class="mh">0xFE</span>
    <span class="n">v9</span> <span class="o">&amp;=</span><span class="mh">0xFF</span> <span class="c1">#to constrain for 8 bit</span>
    <span class="n">key</span> <span class="o">=</span><span class="n">key</span> <span class="o">+</span><span class="nb">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">v9</span><span class="p">))[</span><span class="mi">2</span><span class="p">:],</span><span class="mi">16</span><span class="p">),</span><span class="s2">&quot;02X&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pwn</span><span class="o">.</span><span class="n">xor</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">flag</span><span class="p">)))</span>
</pre></div>
</div>
<img alt="../_images/Screenshot_155.png" src="../_images/Screenshot_155.png" />
</section>
<section id="easy-login">
<h2>easy login<a class="headerlink" href="#easy-login" title="Link to this heading"></a></h2>
<p>We are given two files, both are elf 64bit</p>
<img alt="../_images/Screenshot_165.png" src="../_images/Screenshot_165.png" />
<p>in the easy login binary we get user pass token</p>
<img alt="../_images/Screenshot_174.png" src="../_images/Screenshot_174.png" />
<p>so we check the other binary</p>
<img alt="../_images/Screenshot_184.png" src="../_images/Screenshot_184.png" />
<div class="line-block">
<div class="line">In ida we see set our goal to get final <cite>Correct tokan!</cite></div>
<div class="line">So first we see the first token part (v4) and fixed byte array is passed to sub 1159 which changes it</div>
<div class="line">Then check token parts to if ( v4 == 4068142527 &amp;&amp; v5 == 3976246892 )</div>
</div>
<img alt="../_images/Screenshot_194.png" src="../_images/Screenshot_194.png" />
<p>inside the function is bunch of calcs then set in our first token part, so we reverse the process with final value being if ( v4 == 4068142527 &amp;&amp; v5 == 3976246892 )</p>
<img alt="../_images/Screenshot_203.png" src="../_images/Screenshot_203.png" />
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">reverse_sub_6519F8FD0159</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3337565984</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u&quot;</span><span class="p">,</span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">a1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">a1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v4</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="n">a1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1640531527</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">a1</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v4</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">a2</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">((</span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="n">a1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3337565984</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xED00B66C</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xF27AEDBF</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a2</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">19088743</span><span class="p">,</span><span class="w"> </span><span class="mi">2309737967</span><span class="p">,</span><span class="w"> </span><span class="mi">4275878552</span><span class="p">,</span><span class="w"> </span><span class="mi">1985229328</span><span class="p">};</span>

<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverse_sub_6519F8FD0159</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">);</span>

<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Token generation result:&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%u_%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">v5</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Now we got the token we still need the user and pass, back to easy login binary</div>
<div class="line">we get this code, where the user isn’t used, and the pass and token are passed to function then onto second function which base64</div>
</div>
<img alt="../_images/Screenshot_218.png" src="../_images/Screenshot_218.png" />
<p>Which is then compared to <cite>pDG/SbSehGM2l16sRzFmxRDZNCti2PNXzY9Z</cite></p>
<img alt="../_images/Screenshot_233.png" src="../_images/Screenshot_233.png" />
<img alt="../_images/Screenshot_225.png" src="../_images/Screenshot_225.png" />
<p>opening the first function used we see it is a typical RC4
To recognize RC4 use tools like capa ,sigsrch or its pattern as following:-</p>
<div class="line-block">
<div class="line">There’s usually 3 loops</div>
<div class="line">2x 0x100 iterations: one filling the buffer with values from 0 to ff</div>
<div class="line">One going over the array swapping values</div>
<div class="line">And a 3rd producing the keystream</div>
<div class="line">It is a very recognisable pattern</div>
</div>
<img alt="../_images/Screenshot_244.png" src="../_images/Screenshot_244.png" />
<img alt="../_images/Screenshot_253.png" src="../_images/Screenshot_253.png" />
<p>then we use the token as rc4 key and we get the flag</p>
<img alt="../_images/Screenshot_263.png" src="../_images/Screenshot_263.png" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../mal4/mal4.html" class="btn btn-neutral float-left" title="Vidar" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>